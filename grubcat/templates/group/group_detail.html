{% extends "base.html" %}
{% load static_asset %}
{% load static from staticfiles %}{% load assets %}
{% block title %}{{ group.name }}{% endblock %}
{% block active-nav-id %}nav-group{% endblock %}


{% block page_css %}
    {% assets "group_detail_css" %}
        <link href="{% static_asset ASSET_URL %}" media="screen" rel="stylesheet" type="text/css">
    {% endassets %}
    <link rel="stylesheet" href="{% static 'css/ui/jquery-ui-bootstrap/jquery-ui-1.8.16.bootstrap.css' %}">
    <style type="text/css">
        .error {
            margin: auto auto;
            width: auto;
            padding: 0px;
        }

        #div_id_logo .controls label {
            margin-left: 15px;;
            margin-top: 5px;;
        }

        #logo-clear_id {
            display: block;
            float: left;
            margin-top: 8px;;
        }

        #id_logo {
            -webkit-box-shadow: none;
            -moz-box-shadow: none;
            box-shadow: none;
        }

        form, .form-actions {
            margin-bottom: 0;
        }

        .form-horizontal .control-label {
            width: 60px;
        }

        .form-horizontal .controls {
            margin-left: 80px;
        }

        #div_id_logo {
            margin-top: 10px;;
        }


    </style>

{% endblock %}
{% block content %}

    <div id="banner-wrapper">
        <div id="banner" class="shadow">
            <img class="fl" src="{{ group.logo_url_default_if_none }}" alt="{{ group.name }}" width="96" height="96">
            {% if user == group.owner %}
                <a href="{% url edit_group_logo group.id %}" id="id_edit_logo_link" class="edit-link">
                    <img alt="修改" src="{% static "img/edit-pencil.png" %}">
                </a>
            {% endif %}
            <h1 class="group-name">{{ group.name }}</h1>

            {% if not user.is_authenticated or group not in user.interest_groups.all %}
                <a href="{% url join_group group.id %}" id="id_join_group_link" class="button">加入圈子</a>
            {% else %}
                <a href="" id="id_invite_friend_link" class="button">邀请好友</a>
            {% endif %}
        </div>
    </div>
    <div class="left-column">
        <div class="meal-cell">
            <a href=""></a>

            <img class="meal-cover" alt="Vietnamese Grubs in Lincoln Park" height="200"
                 src="https://d1gwxpes5z0r7f.cloudfront.net/grub_meal_pics/4955/matte/30748_724397484471_1390067_n.jpg?2012"
                 width="228">

            <div class="price-seat">
                $15 - Chicago, IL- 13 seats left
            </div>

            {#            TODO只显示5个#}
            <div class="users">
                <img alt="Karthik Balasubramanian"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/3672/size_30x30/prof%20pic.jpg?2012">
                <img alt="Glen Kato"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/3827/size_30x30/me-and-mryellow_mini.jpg?2012">
                <img alt="Julie Corvo"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/40900/size_30x30/40900/540397_947202850792_857084844_n.jpg">
                <img alt="Nikkie H"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/17014/size_30x30/LinkedIn%20Photo.JPG?2012">
                <img alt="Mark Tudela"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/1456/size_30x30/1456_pic20110521-1-89sb73-0.?2012">
                <img alt="Brittany R"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/48377/size_30x30/48377_pic20120622-16-retfhn.?2012">
            </div>

            <div class="info">
                <h3>Vietnamese Grubs in Park</h3>
                <span class="date"> Thursday, September 06,  7:30PM </span>
            </div>
        </div>
        <hr>
        <h4>Past Meals</h4>

        <div class="meal-cell">
            <a href=""></a>

            <img class="meal-cover" alt="Vietnamese Grubs in Lincoln Park" height="200"
                 src="https://d1gwxpes5z0r7f.cloudfront.net/grub_meal_pics/4955/matte/30748_724397484471_1390067_n.jpg?2012"
                 width="228">

            <div class="price-seat">
                $15 - Chicago, IL- 13 seats left
            </div>

            {#            TODO只显示5个#}
            <div class="users">
                <img alt="Karthik Balasubramanian"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/3672/size_30x30/prof%20pic.jpg?2012">
                <img alt="Glen Kato"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/3827/size_30x30/me-and-mryellow_mini.jpg?2012">
                <img alt="Julie Corvo"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/40900/size_30x30/40900/540397_947202850792_857084844_n.jpg">
                <img alt="Nikkie H"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/17014/size_30x30/LinkedIn%20Photo.JPG?2012">
                <img alt="Mark Tudela"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/1456/size_30x30/1456_pic20110521-1-89sb73-0.?2012">
                <img alt="Brittany R"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/48377/size_30x30/48377_pic20120622-16-retfhn.?2012">
            </div>

            <div class="info">
                <h3>Vietnamese Grubs in Park</h3>
                <span class="date"> Thursday, September 06,  7:30PM </span>
            </div>
        </div>

        <div class="meal-cell">
            <a href=""></a>

            <img class="meal-cover" alt="Vietnamese Grubs in Lincoln Park" height="200"
                 src="https://d1gwxpes5z0r7f.cloudfront.net/grub_meal_pics/4955/matte/30748_724397484471_1390067_n.jpg?2012"
                 width="228">

            <div class="price-seat">
                $15 - Chicago, IL- 13 seats left
            </div>

            {#            TODO只显示5个#}
            <div class="users">
                <img alt="Karthik Balasubramanian"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/3672/size_30x30/prof%20pic.jpg?2012">
                <img alt="Glen Kato"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/3827/size_30x30/me-and-mryellow_mini.jpg?2012">
                <img alt="Julie Corvo"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/40900/size_30x30/40900/540397_947202850792_857084844_n.jpg">
                <img alt="Nikkie H"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/17014/size_30x30/LinkedIn%20Photo.JPG?2012">
                <img alt="Mark Tudela"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/1456/size_30x30/1456_pic20110521-1-89sb73-0.?2012">
                <img alt="Brittany R"
                     src="https://d1gwxpes5z0r7f.cloudfront.net/grub_user_pics/48377/size_30x30/48377_pic20120622-16-retfhn.?2012">
            </div>

            <div class="info">
                <h3>Vietnamese Grubs in Park</h3>
                <span class="date"> Thursday, September 06,  7:30PM </span>
            </div>
        </div>

    </div>
    <div class="right-column">
        <div class="about">
            {% comment %} <h3>About Chicago 20s and 30s Grub Group (Chicago)
                </h3>{% endcomment %}


            <div class="desc">
                {{ group.desc }}
            </div>
            {% if user == group.owner %}
                <a href="{% url edit_group group.id %}" class="edit-link">
                    <img alt="修改" src="{% static "img/edit-pencil.png" %}">
                </a>
            {% endif %}
            {% if group.category %}
                <div class="taglist clearfix">
                    <a href="#" class="tag">{{ group.category.name }}</a>
                </div>
            {% endif %}
        </div>
        <div class="members-wrapper">
            {% with members_count=group.members.count %}
                <h3>{{ members_count }} 位成员
                    {% if members_count > 21 %}
                        <a class="see-all" href="/groups/20sgrubgroup/members">(查看所有)</a>
                    {% endif %}
                    {% if group in user.interest_groups.all and user != group.owner %}
                        | <a href="{% url leave_group group.id %}" id="id_leave_group_link">离开</a>
                    {% endif %}
                </h3>

                <div class="members clearfix">
                    <span class="owner">创建者</span>
                    {% for member in group.members.all|slice:":21" %}
                        <a href="" class="user-avatar" title="{{ member.username }}">
                            <img alt="{{ member.username }}" width="40" height="40"
                                 src="{{ MEDIA_URL }}{{ member.get_profile.avatar_default_if_none }}">
                        </a>
                    {% endfor %}
                </div>
                <br clear="all">
            {% endwith %}
        </div>
        <div class="comments">
            <h3>说点什么吧！</h3>


            <div class="wrapper-for-group-comments">

                {% if not user.is_authenticated %}
                    <div class="join-to-comment">您需要登录才能加入会话！</div>
                {% elif group in user.interest_groups.all %}
                    <div class="new-comment clearfix">
                        <img alt="{{ requestr.user.username }}" width="75" height="75"
                             src="{{ MEDIA_URL }}{{ user.get_profile.avatar_default_if_none }}">

                        <h3>{{ user.username }}</h3>

                        <form accept-charset="UTF-8" action="{% url create_group_comment %}"
                              class="add_comment_form new_comment_form"
                              id="id_add_comment_form" method="post">
                            <textarea class="tag-comment toggleval new_comment_field comment-reply-field" cols="40"
                                      name="comment" rows="20" id="id_comment_content"
                                      title="Share something with the Chicago Tech group..."
                                      style="resize: none; overflow-y: hidden; height: 40px; "></textarea>
                            <input type="hidden" name="group" value="{{ group.id }}">
                            <input type="hidden" name="from_person" value="{{ user.get_profile.id }}">
                            <input class="showloading add_comment_submit button" id="id_add_comment_submit"
                                   type="submit" value="发表">
                        </form>
                    </div>
                {% else %}
                    <div class="join-to-comment">您需要加入圈子后才能加入会话！</div>
                {% endif %}
                <div id="comments-wrapper">
                    {% for comment in group.comments.all reversed %}
                        {% if not comment.parent %}
                            <div class="parent-comment clearfix">
                                <a href="{% url user_detail comment.from_person.id %}"><img
                                        alt="{{ comment.from_person.user.username }}" width="75" height="75"
                                        src="{{ MEDIA_URL }}{{ comment.from_person.avatar_default_if_none }}"></a>

                                <div class="comment-content">
                                    <h3>
                                        <a href="{% url user_detail comment.from_person.id %}">{{ comment.from_person.user.username }}</a>
                                    </h3>

                                    <div class="comment-widget">
                                        <span>{{ comment.time_gap }} </span>
                                    </div>
                                    <p>{{ comment.comment }}</p>

                                    <div class="replies">
                                        {% for reply in comment.replies.all reversed %}
                                            <div class="child-comment " id="comment_8650">
                                                <div class="comment-title"><a
                                                        href="{% url user_detail reply.from_person.id %}">
                                                    <img alt="{{ reply.from_person.user.username }}" width="40"
                                                         height="40"
                                                         src="







                                                                 {{ MEDIA_URL }}{{ reply.from_person.avatar_default_if_none }}"></a>
                                                    <b><a href="{% url user_detail reply.from_person.id %}">{{ reply.from_person.user.username }}</a></b>
                                                    <span>({{ reply.time_gap }}) </span>
                                                </div>
                                                <p>{{ reply.comment }}</p>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                    <div class="meals_pagination" id="comments-pagination">

                    </div>

                </div>

            </div>

        </div>
    </div>

    <div id="id_edit_logo_dialog" class="hide">

    </div>

{% endblock %}
{% block base_js %}
    {{ block.super }}
    {% assets "jquery_ui_js" %}
        <script type="text/javascript" src="{% static_asset ASSET_URL %}"></script>
    {% endassets %}
    {% assets "jquery_form_js" %}
        <script type="text/javascript" src="{% static_asset ASSET_URL %}"></script>
    {% endassets %}
{% endblock %}
{% block page_js %}
    <script type="text/javascript">
        function loadEditLogoPage() {
            $("#id_create_group_form").ajaxForm({
                success:function (html) {
                    var $html = $(html);
                    if ($html.is("a.auto-close") && $html.attr('href')) {
                        window.location.href = $html.attr('href');
                    } else {
                        $("#id_edit_logo_dialog").html($html.find(".content"));
                        loadEditLogoPage();
                    }
                }
            })
            $("#id_edit_logo_dialog").dialog({
                autoOpen:true,
                title:"修改Logo",
                modal:true,
                width:440,
                height:260,
                position:['center', 100],
                resizable:false
            });
            $("<br/>").insertBefore($("#logo-clear_id"));
            $("input[type=submit]").focus()
        }
        $(document).ready(function () {
            //dix should be 'div', a hack for djdebugtool
            var newCommentTemplate = '' +
                    '<dix class="parent-comment clearfix">' +
                    '   <a href="{% url user_detail user.get_profile.id %}">' +
                    '       <img alt="{{ user.username }}" width="75" height="75" src="{{ MEDIA_URL }}{{ user.get_profile.avatar_default_if_none }}">' +
                    '    </a>' +
                    '   <dix class="comment-content">' +
                    '       <h3><a href="{% url user_detail user.get_profile.id %}">{{ user.username }}</a></h3>' +
                    '       <dix class="comment-widget"><span>$time_gap</span></dix>' +
                    '       <p>$comment_content</p> </dix> </dix> ';
            newCommentTemplate = newCommentTemplate.replace('dix','div')
            $("#id_edit_logo_link").click(function () {
                $("#id_edit_logo_dialog").load($("#id_edit_logo_link").attr('href') + " .content", loadEditLogoPage);
                return false;
            });
            $("#id_join_group_link,#id_leave_group_link").click(function () {
                $.post($(this).attr('href'), function (data) {
                    if (data.status == "OK") {
                        window.location = '{{  request.path }}';
                    }
                });
                return false;
            })
            $("#id_add_comment_form").ajaxForm({
                dataType:'json',
                beforeSubmit:function () {
                    if (!$("#id_comment_content").val()) {
                        $("#id_comment_content").focus();
                    }
                },
                success:function (data) {
                    if (data.status == "OK") {
                        var newCommentDiv = newCommentTemplate.replace('$id',data.id).replace('$time_gap',  data.time_gap).replace('$comment_content',$("#id_comment_content").val())
                        $("#comments-wrapper").prepend(newCommentDiv);
                    }
                }
            })
        })
    </script>
{% endblock %}