(function(){var y=this;var m=y._;var F={};var E=Array.prototype,f=Object.prototype,t=Function.prototype;var I=E.push,q=E.slice,A=E.concat,d=f.toString,l=f.hasOwnProperty;var M=E.forEach,s=E.map,G=E.reduce,c=E.reduceRight,b=E.filter,D=E.every,r=E.some,p=E.indexOf,n=E.lastIndexOf,w=Array.isArray,e=Object.keys,H=t.bind;var N=function(O){if(O instanceof N){return O}if(!(this instanceof N)){return new N(O)}this._wrapped=O};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=N}exports._=N}else{y._=N}N.VERSION="1.4.4";var J=N.each=N.forEach=function(T,S,R){if(T==null){return}if(M&&T.forEach===M){T.forEach(S,R)}else{if(T.length===+T.length){for(var Q=0,O=T.length;Q<O;Q++){if(S.call(R,T[Q],Q,T)===F){return}}}else{for(var P in T){if(N.has(T,P)){if(S.call(R,T[P],P,T)===F){return}}}}}};N.map=N.collect=function(R,Q,P){var O=[];if(R==null){return O}if(s&&R.map===s){return R.map(Q,P)}J(R,function(U,S,T){O[O.length]=Q.call(P,U,S,T)});return O};var g="Reduce of empty array with no initial value";N.reduce=N.foldl=N.inject=function(S,R,O,Q){var P=arguments.length>2;if(S==null){S=[]}if(G&&S.reduce===G){if(Q){R=N.bind(R,Q)}return P?S.reduce(R,O):S.reduce(R)}J(S,function(V,T,U){if(!P){O=V;P=true}else{O=R.call(Q,O,V,T,U)}});if(!P){throw new TypeError(g)}return O};N.reduceRight=N.foldr=function(U,R,O,Q){var P=arguments.length>2;if(U==null){U=[]}if(c&&U.reduceRight===c){if(Q){R=N.bind(R,Q)}return P?U.reduceRight(R,O):U.reduceRight(R)}var T=U.length;if(T!==+T){var S=N.keys(U);T=S.length}J(U,function(X,V,W){V=S?S[--T]:--T;if(!P){O=U[V];P=true}else{O=R.call(Q,O,U[V],V,W)}});if(!P){throw new TypeError(g)}return O};N.find=N.detect=function(R,Q,P){var O;C(R,function(U,S,T){if(Q.call(P,U,S,T)){O=U;return true}});return O};N.filter=N.select=function(R,Q,P){var O=[];if(R==null){return O}if(b&&R.filter===b){return R.filter(Q,P)}J(R,function(U,S,T){if(Q.call(P,U,S,T)){O[O.length]=U}});return O};N.reject=function(Q,P,O){return N.filter(Q,function(T,R,S){return !P.call(O,T,R,S)},O)};N.every=N.all=function(R,Q,P){Q||(Q=N.identity);var O=true;if(R==null){return O}if(D&&R.every===D){return R.every(Q,P)}J(R,function(U,S,T){if(!(O=O&&Q.call(P,U,S,T))){return F}});return !!O};var C=N.some=N.any=function(R,Q,P){Q||(Q=N.identity);var O=false;if(R==null){return O}if(r&&R.some===r){return R.some(Q,P)}J(R,function(U,S,T){if(O||(O=Q.call(P,U,S,T))){return F}});return !!O};N.contains=N.include=function(P,O){if(P==null){return false}if(p&&P.indexOf===p){return P.indexOf(O)!=-1}return C(P,function(Q){return Q===O})};N.invoke=function(Q,R){var O=q.call(arguments,2);var P=N.isFunction(R);return N.map(Q,function(S){return(P?R:S[R]).apply(S,O)})};N.pluck=function(P,O){return N.map(P,function(Q){return Q[O]})};N.where=function(P,O,Q){if(N.isEmpty(O)){return Q?null:[]}return N[Q?"find":"filter"](P,function(S){for(var R in O){if(O[R]!==S[R]){return false}}return true})};N.findWhere=function(P,O){return N.where(P,O,true)};N.max=function(R,Q,P){if(!Q&&N.isArray(R)&&R[0]===+R[0]&&R.length<65535){return Math.max.apply(Math,R)}if(!Q&&N.isEmpty(R)){return -Infinity}var O={computed:-Infinity,value:-Infinity};J(R,function(V,S,U){var T=Q?Q.call(P,V,S,U):V;T>=O.computed&&(O={value:V,computed:T})});return O.value};N.min=function(R,Q,P){if(!Q&&N.isArray(R)&&R[0]===+R[0]&&R.length<65535){return Math.min.apply(Math,R)}if(!Q&&N.isEmpty(R)){return Infinity}var O={computed:Infinity,value:Infinity};J(R,function(V,S,U){var T=Q?Q.call(P,V,S,U):V;T<O.computed&&(O={value:V,computed:T})});return O.value};N.shuffle=function(R){var Q;var P=0;var O=[];J(R,function(S){Q=N.random(P++);O[P-1]=O[Q];O[Q]=S});return O};var a=function(O){return N.isFunction(O)?O:function(P){return P[O]}};N.sortBy=function(R,Q,O){var P=a(Q);return N.pluck(N.map(R,function(U,S,T){return{value:U,index:S,criteria:P.call(O,U,S,T)}}).sort(function(V,U){var T=V.criteria;var S=U.criteria;if(T!==S){if(T>S||T===void 0){return 1}if(T<S||S===void 0){return -1}}return V.index<U.index?-1:1}),"value")};var v=function(T,S,P,R){var O={};var Q=a(S||N.identity);J(T,function(W,U){var V=Q.call(P,W,U,T);R(O,V,W)});return O};N.groupBy=function(Q,P,O){return v(Q,P,O,function(R,S,T){(N.has(R,S)?R[S]:(R[S]=[])).push(T)})};N.countBy=function(Q,P,O){return v(Q,P,O,function(R,S){if(!N.has(R,S)){R[S]=0}R[S]++})};N.sortedIndex=function(V,U,R,Q){R=R==null?N.identity:a(R);var T=R.call(Q,U);var O=0,S=V.length;while(O<S){var P=(O+S)>>>1;R.call(Q,V[P])<T?O=P+1:S=P}return O};N.toArray=function(O){if(!O){return[]}if(N.isArray(O)){return q.call(O)}if(O.length===+O.length){return N.map(O,N.identity)}return N.values(O)};N.size=function(O){if(O==null){return 0}return(O.length===+O.length)?O.length:N.keys(O).length};N.first=N.head=N.take=function(Q,P,O){if(Q==null){return void 0}return(P!=null)&&!O?q.call(Q,0,P):Q[0]};N.initial=function(Q,P,O){return q.call(Q,0,Q.length-((P==null)||O?1:P))};N.last=function(Q,P,O){if(Q==null){return void 0}if((P!=null)&&!O){return q.call(Q,Math.max(Q.length-P,0))}else{return Q[Q.length-1]}};N.rest=N.tail=N.drop=function(Q,P,O){return q.call(Q,(P==null)||O?1:P)};N.compact=function(O){return N.filter(O,N.identity)};var z=function(P,Q,O){J(P,function(R){if(N.isArray(R)){Q?I.apply(O,R):z(R,Q,O)}else{O.push(R)}});return O};N.flatten=function(P,O){return z(P,O,[])};N.without=function(O){return N.difference(O,q.call(arguments,1))};N.uniq=N.unique=function(U,T,S,R){if(N.isFunction(T)){R=S;S=T;T=false}var P=S?N.map(U,S,R):U;var Q=[];var O=[];J(P,function(W,V){if(T?(!V||O[O.length-1]!==W):!N.contains(O,W)){O.push(W);Q.push(U[V])}});return Q};N.union=function(){return N.uniq(A.apply(E,arguments))};N.intersection=function(P){var O=q.call(arguments,1);return N.filter(N.uniq(P),function(Q){return N.every(O,function(R){return N.indexOf(R,Q)>=0})})};N.difference=function(P){var O=A.apply(E,q.call(arguments,1));return N.filter(P,function(Q){return !N.contains(O,Q)})};N.zip=function(){var O=q.call(arguments);var R=N.max(N.pluck(O,"length"));var Q=new Array(R);for(var P=0;P<R;P++){Q[P]=N.pluck(O,""+P)}return Q};N.object=function(S,Q){if(S==null){return{}}var O={};for(var R=0,P=S.length;R<P;R++){if(Q){O[S[R]]=Q[R]}else{O[S[R][0]]=S[R][1]}}return O};N.indexOf=function(S,Q,R){if(S==null){return -1}var P=0,O=S.length;if(R){if(typeof R=="number"){P=(R<0?Math.max(0,O+R):R)}else{P=N.sortedIndex(S,Q);return S[P]===Q?P:-1}}if(p&&S.indexOf===p){return S.indexOf(Q,R)}for(;P<O;P++){if(S[P]===Q){return P}}return -1};N.lastIndexOf=function(S,Q,R){if(S==null){return -1}var O=R!=null;if(n&&S.lastIndexOf===n){return O?S.lastIndexOf(Q,R):S.lastIndexOf(Q)}var P=(O?R:S.length);while(P--){if(S[P]===Q){return P}}return -1};N.range=function(T,R,S){if(arguments.length<=1){R=T||0;T=0}S=arguments[2]||1;var P=Math.max(Math.ceil((R-T)/S),0);var O=0;var Q=new Array(P);while(O<P){Q[O++]=T;T+=S}return Q};N.bind=function(Q,P){if(Q.bind===H&&H){return H.apply(Q,q.call(arguments,1))}var O=q.call(arguments,2);return function(){return Q.apply(P,O.concat(q.call(arguments)))}};N.partial=function(P){var O=q.call(arguments,1);return function(){return P.apply(this,O.concat(q.call(arguments)))}};N.bindAll=function(P){var O=q.call(arguments,1);if(O.length===0){O=N.functions(P)}J(O,function(Q){P[Q]=N.bind(P[Q],P)});return P};N.memoize=function(Q,P){var O={};P||(P=N.identity);return function(){var R=P.apply(this,arguments);return N.has(O,R)?O[R]:(O[R]=Q.apply(this,arguments))}};N.delay=function(P,Q){var O=q.call(arguments,2);return setTimeout(function(){return P.apply(null,O)},Q)};N.defer=function(O){return N.delay.apply(N,[O,1].concat(q.call(arguments,1)))};N.throttle=function(T,V){var R,Q,U,O;var S=0;var P=function(){S=new Date;U=null;O=T.apply(R,Q)};return function(){var W=new Date;var X=V-(W-S);R=this;Q=arguments;if(X<=0){clearTimeout(U);U=null;S=W;O=T.apply(R,Q)}else{if(!U){U=setTimeout(P,X)}}return O}};N.debounce=function(Q,S,P){var R,O;return function(){var W=this,V=arguments;var U=function(){R=null;if(!P){O=Q.apply(W,V)}};var T=P&&!R;clearTimeout(R);R=setTimeout(U,S);if(T){O=Q.apply(W,V)}return O}};N.once=function(Q){var O=false,P;return function(){if(O){return P}O=true;P=Q.apply(this,arguments);Q=null;return P}};N.wrap=function(O,P){return function(){var Q=[O];I.apply(Q,arguments);return P.apply(this,Q)}};N.compose=function(){var O=arguments;return function(){var P=arguments;for(var Q=O.length-1;Q>=0;Q--){P=[O[Q].apply(this,P)]}return P[0]}};N.after=function(P,O){if(P<=0){return O()}return function(){if(--P<1){return O.apply(this,arguments)}}};N.keys=e||function(Q){if(Q!==Object(Q)){throw new TypeError("Invalid object")}var P=[];for(var O in Q){if(N.has(Q,O)){P[P.length]=O}}return P};N.values=function(Q){var O=[];for(var P in Q){if(N.has(Q,P)){O.push(Q[P])}}return O};N.pairs=function(Q){var P=[];for(var O in Q){if(N.has(Q,O)){P.push([O,Q[O]])}}return P};N.invert=function(Q){var O={};for(var P in Q){if(N.has(Q,P)){O[Q[P]]=P}}return O};N.functions=N.methods=function(Q){var P=[];for(var O in Q){if(N.isFunction(Q[O])){P.push(O)}}return P.sort()};N.extend=function(O){J(q.call(arguments,1),function(P){if(P){for(var Q in P){O[Q]=P[Q]}}});return O};N.pick=function(P){var Q={};var O=A.apply(E,q.call(arguments,1));J(O,function(R){if(R in P){Q[R]=P[R]}});return Q};N.omit=function(Q){var R={};var P=A.apply(E,q.call(arguments,1));for(var O in Q){if(!N.contains(P,O)){R[O]=Q[O]}}return R};N.defaults=function(O){J(q.call(arguments,1),function(P){if(P){for(var Q in P){if(O[Q]==null){O[Q]=P[Q]}}}});return O};N.clone=function(O){if(!N.isObject(O)){return O}return N.isArray(O)?O.slice():N.extend({},O)};N.tap=function(P,O){O(P);return P};var K=function(V,U,P,Q){if(V===U){return V!==0||1/V==1/U}if(V==null||U==null){return V===U}if(V instanceof N){V=V._wrapped}if(U instanceof N){U=U._wrapped}var S=d.call(V);if(S!=d.call(U)){return false}switch(S){case"[object String]":return V==String(U);case"[object Number]":return V!=+V?U!=+U:(V==0?1/V==1/U:V==+U);case"[object Date]":case"[object Boolean]":return +V==+U;case"[object RegExp]":return V.source==U.source&&V.global==U.global&&V.multiline==U.multiline&&V.ignoreCase==U.ignoreCase}if(typeof V!="object"||typeof U!="object"){return false}var O=P.length;while(O--){if(P[O]==V){return Q[O]==U}}P.push(V);Q.push(U);var X=0,Y=true;if(S=="[object Array]"){X=V.length;Y=X==U.length;if(Y){while(X--){if(!(Y=K(V[X],U[X],P,Q))){break}}}}else{var T=V.constructor,R=U.constructor;if(T!==R&&!(N.isFunction(T)&&(T instanceof T)&&N.isFunction(R)&&(R instanceof R))){return false}for(var W in V){if(N.has(V,W)){X++;if(!(Y=N.has(U,W)&&K(V[W],U[W],P,Q))){break}}}if(Y){for(W in U){if(N.has(U,W)&&!(X--)){break}}Y=!X}}P.pop();Q.pop();return Y};N.isEqual=function(P,O){return K(P,O,[],[])};N.isEmpty=function(P){if(P==null){return true}if(N.isArray(P)||N.isString(P)){return P.length===0}for(var O in P){if(N.has(P,O)){return false}}return true};N.isElement=function(O){return !!(O&&O.nodeType===1)};N.isArray=w||function(O){return d.call(O)=="[object Array]"};N.isObject=function(O){return O===Object(O)};J(["Arguments","Function","String","Number","Date","RegExp"],function(O){N["is"+O]=function(P){return d.call(P)=="[object "+O+"]"}});if(!N.isArguments(arguments)){N.isArguments=function(O){return !!(O&&N.has(O,"callee"))}}if(typeof(/./)!=="function"){N.isFunction=function(O){return typeof O==="function"}}N.isFinite=function(O){return isFinite(O)&&!isNaN(parseFloat(O))};N.isNaN=function(O){return N.isNumber(O)&&O!=+O};N.isBoolean=function(O){return O===true||O===false||d.call(O)=="[object Boolean]"};N.isNull=function(O){return O===null};N.isUndefined=function(O){return O===void 0};N.has=function(P,O){return l.call(P,O)};N.noConflict=function(){y._=m;return this};N.identity=function(O){return O};N.times=function(S,R,Q){var O=Array(S);for(var P=0;P<S;P++){O[P]=R.call(Q,P)}return O};N.random=function(P,O){if(O==null){O=P;P=0}return P+Math.floor(Math.random()*(O-P+1))};var o={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};o.unescape=N.invert(o.escape);var L={escape:new RegExp("["+N.keys(o.escape).join("")+"]","g"),unescape:new RegExp("("+N.keys(o.unescape).join("|")+")","g")};N.each(["escape","unescape"],function(O){N[O]=function(P){if(P==null){return""}return(""+P).replace(L[O],function(Q){return o[O][Q]})}});N.result=function(O,Q){if(O==null){return null}var P=O[Q];return N.isFunction(P)?P.call(O):P};N.mixin=function(O){J(N.functions(O),function(P){var Q=N[P]=O[P];N.prototype[P]=function(){var R=[this._wrapped];I.apply(R,arguments);return u.call(this,Q.apply(N,R))}})};var B=0;N.uniqueId=function(O){var P=++B+"";return O?O+P:P};N.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var x=/(.)^/;var h={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028","\u2029":"u2029"};var j=/\\|'|\r|\n|\t|\u2028|\u2029/g;N.template=function(W,R,Q){var P;Q=N.defaults({},Q,N.templateSettings);var S=new RegExp([(Q.escape||x).source,(Q.interpolate||x).source,(Q.evaluate||x).source].join("|")+"|$","g");var T=0;var O="__p+='";W.replace(S,function(Y,Z,X,ab,aa){O+=W.slice(T,aa).replace(j,function(ac){return"\\"+h[ac]});if(Z){O+="'+\n((__t=("+Z+"))==null?'':_.escape(__t))+\n'"}if(X){O+="'+\n((__t=("+X+"))==null?'':__t)+\n'"}if(ab){O+="';\n"+ab+"\n__p+='"}T=aa+Y.length;return Y});O+="';\n";if(!Q.variable){O="with(obj||{}){\n"+O+"}\n"}O="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+O+"return __p;\n";try{P=new Function(Q.variable||"obj","_",O)}catch(U){U.source=O;throw U}if(R){return P(R,N)}var V=function(X){return P.call(this,X,N)};V.source="function("+(Q.variable||"obj")+"){\n"+O+"}";return V};N.chain=function(O){return N(O).chain()};var u=function(O){return this._chain?N(O).chain():O};N.mixin(N);J(["pop","push","reverse","shift","sort","splice","unshift"],function(O){var P=E[O];N.prototype[O]=function(){var Q=this._wrapped;P.apply(Q,arguments);if((O=="shift"||O=="splice")&&Q.length===0){delete Q[0]}return u.call(this,Q)}});J(["concat","join","slice"],function(O){var P=E[O];N.prototype[O]=function(){return u.call(this,P.apply(this._wrapped,arguments))}});N.extend(N.prototype,{chain:function(){this._chain=true;return this},value:function(){return this._wrapped}})}).call(this);(function(){var w=this;var D=w.Backbone;var g=[];var F=g.push;var p=g.slice;var v=g.splice;var B;if(typeof exports!=="undefined"){B=exports}else{B=w.Backbone={}}B.VERSION="1.0.0";var N=w._;if(!N&&(typeof require!=="undefined")){N=require("underscore")}B.$=w.jQuery||w.Zepto||w.ender||w.$;B.noConflict=function(){w.Backbone=D;return this};B.emulateHTTP=false;B.emulateJSON=false;var L=B.Events={on:function(O,R,Q){if(!z(this,"on",O,[R,Q])||!R){return this}this._events||(this._events={});var P=this._events[O]||(this._events[O]=[]);P.push({callback:R,context:Q,ctx:Q||this});return this},once:function(P,S,Q){if(!z(this,"once",P,[S,Q])||!S){return this}var O=this;var R=N.once(function(){O.off(P,R);S.apply(this,arguments)});R._callback=S;return this.on(P,R,Q)},off:function(O,X,P){var V,W,Y,U,T,Q,S,R;if(!this._events||!z(this,"off",O,[X,P])){return this}if(!O&&!X&&!P){this._events={};return this}U=O?[O]:N.keys(this._events);for(T=0,Q=U.length;T<Q;T++){O=U[T];if(Y=this._events[O]){this._events[O]=V=[];if(X||P){for(S=0,R=Y.length;S<R;S++){W=Y[S];if((X&&X!==W.callback&&X!==W.callback._callback)||(P&&P!==W.context)){V.push(W)}}}if(!V.length){delete this._events[O]}}}return this},trigger:function(Q){if(!this._events){return this}var P=p.call(arguments,1);if(!z(this,"trigger",Q,P)){return this}var R=this._events[Q];var O=this._events.all;if(R){b(R,P)}if(O){b(O,arguments)}return this},stopListening:function(R,O,T){var P=this._listeners;if(!P){return this}var Q=!O&&!T;if(typeof O==="object"){T=this}if(R){(P={})[R._listenerId]=R}for(var S in P){P[S].off(O,T,this);if(Q){delete this._listeners[S]}}return this}};var y=/\s+/;var z=function(V,T,P,S){if(!P){return true}if(typeof P==="object"){for(var R in P){V[T].apply(V,[R,P[R]].concat(S))}return false}if(y.test(P)){var U=P.split(y);for(var Q=0,O=U.length;Q<O;Q++){V[T].apply(V,[U[Q]].concat(S))}return false}return true};var b=function(T,R){var U,S=-1,Q=T.length,P=R[0],O=R[1],V=R[2];switch(R.length){case 0:while(++S<Q){(U=T[S]).callback.call(U.ctx)}return;case 1:while(++S<Q){(U=T[S]).callback.call(U.ctx,P)}return;case 2:while(++S<Q){(U=T[S]).callback.call(U.ctx,P,O)}return;case 3:while(++S<Q){(U=T[S]).callback.call(U.ctx,P,O,V)}return;default:while(++S<Q){(U=T[S]).callback.apply(U.ctx,R)}}};var E={listenTo:"on",listenToOnce:"once"};N.each(E,function(O,P){L[P]=function(S,Q,U){var R=this._listeners||(this._listeners={});var T=S._listenerId||(S._listenerId=N.uniqueId("l"));R[T]=S;if(typeof Q==="object"){U=this}S[O](Q,U,this);return this}});L.bind=L.on;L.unbind=L.off;N.extend(B,L);var G=B.Model=function(O,Q){var R;var P=O||{};Q||(Q={});this.cid=N.uniqueId("c");this.attributes={};N.extend(this,N.pick(Q,H));if(Q.parse){P=this.parse(P,Q)||{}}if(R=N.result(this,"defaults")){P=N.defaults({},P,R)}this.set(P,Q);this.changed={};this.initialize.apply(this,arguments)};var H=["url","urlRoot","collection"];N.extend(G.prototype,L,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(O){return N.clone(this.attributes)},sync:function(){return B.sync.apply(this,arguments)},get:function(O){return this.attributes[O]},escape:function(O){return N.escape(this.get(O))},has:function(O){return this.get(O)!=null},set:function(W,O,aa){var U,X,Y,V,T,Z,Q,S;if(W==null){return this}if(typeof W==="object"){X=W;aa=O}else{(X={})[W]=O}aa||(aa={});if(!this._validate(X,aa)){return false}Y=aa.unset;T=aa.silent;V=[];Z=this._changing;this._changing=true;if(!Z){this._previousAttributes=N.clone(this.attributes);this.changed={}}S=this.attributes,Q=this._previousAttributes;if(this.idAttribute in X){this.id=X[this.idAttribute]}for(U in X){O=X[U];if(!N.isEqual(S[U],O)){V.push(U)}if(!N.isEqual(Q[U],O)){this.changed[U]=O}else{delete this.changed[U]}Y?delete S[U]:S[U]=O}if(!T){if(V.length){this._pending=true}for(var R=0,P=V.length;R<P;R++){this.trigger("change:"+V[R],this,S[V[R]],aa)}}if(Z){return this}if(!T){while(this._pending){this._pending=false;this.trigger("change",this,aa)}}this._pending=false;this._changing=false;return this},unset:function(O,P){return this.set(O,void 0,N.extend({},P,{unset:true}))},clear:function(P){var O={};for(var Q in this.attributes){O[Q]=void 0}return this.set(O,N.extend({},P,{unset:true}))},hasChanged:function(O){if(O==null){return !N.isEmpty(this.changed)}return N.has(this.changed,O)},changedAttributes:function(Q){if(!Q){return this.hasChanged()?N.clone(this.changed):false}var S,R=false;var P=this._changing?this._previousAttributes:this.attributes;for(var O in Q){if(N.isEqual(P[O],(S=Q[O]))){continue}(R||(R={}))[O]=S}return R},previous:function(O){if(O==null||!this._previousAttributes){return null}return this._previousAttributes[O]},previousAttributes:function(){return N.clone(this._previousAttributes)},fetch:function(P){P=P?N.clone(P):{};if(P.parse===void 0){P.parse=true}var O=this;var Q=P.success;P.success=function(R){if(!O.set(O.parse(R,P),P)){return false}if(Q){Q(O,R,P)}O.trigger("sync",O,R,P)};J(this,P);return this.sync("read",this,P)},save:function(S,P,W){var T,O,V,Q=this.attributes;if(S==null||typeof S==="object"){T=S;W=P}else{(T={})[S]=P}if(T&&(!W||!W.wait)&&!this.set(T,W)){return false}W=N.extend({validate:true},W);if(!this._validate(T,W)){return false}if(T&&W.wait){this.attributes=N.extend({},Q,T)}if(W.parse===void 0){W.parse=true}var R=this;var U=W.success;W.success=function(Y){R.attributes=Q;var X=R.parse(Y,W);if(W.wait){X=N.extend(T||{},X)}if(N.isObject(X)&&!R.set(X,W)){return false}if(U){U(R,Y,W)}R.trigger("sync",R,Y,W)};J(this,W);O=this.isNew()?"create":(W.patch?"patch":"update");if(O==="patch"){W.attrs=T}V=this.sync(O,this,W);if(T&&W.wait){this.attributes=Q}return V},destroy:function(P){P=P?N.clone(P):{};var O=this;var S=P.success;var Q=function(){O.trigger("destroy",O,O.collection,P)};P.success=function(T){if(P.wait||O.isNew()){Q()}if(S){S(O,T,P)}if(!O.isNew()){O.trigger("sync",O,T,P)}};if(this.isNew()){P.success();return false}J(this,P);var R=this.sync("delete",this,P);if(!P.wait){Q()}return R},url:function(){var O=N.result(this,"urlRoot")||N.result(this.collection,"url")||t();if(this.isNew()){return O}return O+(O.charAt(O.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(P,O){return P},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(O){return this._validate({},N.extend(O||{},{validate:true}))},_validate:function(Q,P){if(!P.validate||!this.validate){return true}Q=N.extend({},this.attributes,Q);var O=this.validationError=this.validate(Q,P)||null;if(!O){return true}this.trigger("invalid",this,O,N.extend(P||{},{validationError:O}));return false}});var a=["keys","values","pairs","invert","pick","omit"];N.each(a,function(O){G.prototype[O]=function(){var P=p.call(arguments);P.unshift(this.attributes);return N[O].apply(N,P)}});var c=B.Collection=function(P,O){O||(O={});if(O.url){this.url=O.url}if(O.model){this.model=O.model}if(O.comparator!==void 0){this.comparator=O.comparator}this._reset();this.initialize.apply(this,arguments);if(P){this.reset(P,N.extend({silent:true},O))}};var q={add:true,remove:true,merge:true};var M={add:true,merge:false,remove:false};N.extend(c.prototype,L,{model:G,initialize:function(){},toJSON:function(O){return this.map(function(P){return P.toJSON(O)})},sync:function(){return B.sync.apply(this,arguments)},add:function(P,O){return this.set(P,N.defaults(O||{},M))},remove:function(T,R){T=N.isArray(T)?T.slice():[T];R||(R={});var S,O,Q,P;for(S=0,O=T.length;S<O;S++){P=this.get(T[S]);if(!P){continue}delete this._byId[P.id];delete this._byId[P.cid];Q=this.indexOf(P);this.models.splice(Q,1);this.length--;if(!R.silent){R.index=Q;P.trigger("remove",P,this,R)}this._removeReference(P)}return this},set:function(P,ab){ab=N.defaults(ab||{},q);if(ab.parse){P=this.parse(P,ab)}if(!N.isArray(P)){P=P?[P]:[]}var W,S,Y,Z,Q,X;var R=ab.at;var V=this.comparator&&(R==null)&&ab.sort!==false;var T=N.isString(this.comparator)?this.comparator:null;var aa=[],O=[],U={};for(W=0,S=P.length;W<S;W++){if(!(Y=this._prepareModel(P[W],ab))){continue}if(Q=this.get(Y)){if(ab.remove){U[Q.cid]=true}if(ab.merge){Q.set(Y.attributes,ab);if(V&&!X&&Q.hasChanged(T)){X=true}}}else{if(ab.add){aa.push(Y);Y.on("all",this._onModelEvent,this);this._byId[Y.cid]=Y;if(Y.id!=null){this._byId[Y.id]=Y}}}}if(ab.remove){for(W=0,S=this.length;W<S;++W){if(!U[(Y=this.models[W]).cid]){O.push(Y)}}if(O.length){this.remove(O,ab)}}if(aa.length){if(V){X=true}this.length+=aa.length;if(R!=null){v.apply(this.models,[R,0].concat(aa))}else{F.apply(this.models,aa)}}if(X){this.sort({silent:true})}if(ab.silent){return this}for(W=0,S=aa.length;W<S;W++){(Y=aa[W]).trigger("add",Y,this,ab)}if(X){this.trigger("sort",this,ab)}return this},reset:function(R,P){P||(P={});for(var Q=0,O=this.models.length;Q<O;Q++){this._removeReference(this.models[Q])}P.previousModels=this.models;this._reset();this.add(R,N.extend({silent:true},P));if(!P.silent){this.trigger("reset",this,P)}return this},push:function(P,O){P=this._prepareModel(P,O);this.add(P,N.extend({at:this.length},O));return P},pop:function(P){var O=this.at(this.length-1);this.remove(O,P);return O},unshift:function(P,O){P=this._prepareModel(P,O);this.add(P,N.extend({at:0},O));return P},shift:function(P){var O=this.at(0);this.remove(O,P);return O},slice:function(P,O){return this.models.slice(P,O)},get:function(O){if(O==null){return void 0}return this._byId[O.id!=null?O.id:O.cid||O]},at:function(O){return this.models[O]},where:function(O,P){if(N.isEmpty(O)){return P?void 0:[]}return this[P?"find":"filter"](function(Q){for(var R in O){if(O[R]!==Q.get(R)){return false}}return true})},findWhere:function(O){return this.where(O,true)},sort:function(O){if(!this.comparator){throw new Error("Cannot sort a set without a comparator")}O||(O={});if(N.isString(this.comparator)||this.comparator.length===1){this.models=this.sortBy(this.comparator,this)}else{this.models.sort(N.bind(this.comparator,this))}if(!O.silent){this.trigger("sort",this,O)}return this},sortedIndex:function(O,R,P){R||(R=this.comparator);var Q=N.isFunction(R)?R:function(S){return S.get(R)};return N.sortedIndex(this.models,O,Q,P)},pluck:function(O){return N.invoke(this.models,"get",O)},fetch:function(O){O=O?N.clone(O):{};if(O.parse===void 0){O.parse=true}var Q=O.success;var P=this;O.success=function(R){var S=O.reset?"reset":"set";P[S](R,O);if(Q){Q(P,R,O)}P.trigger("sync",P,R,O)};J(this,O);return this.sync("read",this,O)},create:function(P,O){O=O?N.clone(O):{};if(!(P=this._prepareModel(P,O))){return false}if(!O.wait){this.add(P,O)}var R=this;var Q=O.success;O.success=function(S){if(O.wait){R.add(P,O)}if(Q){Q(P,S,O)}};P.save(null,O);return P},parse:function(P,O){return P},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(Q,P){if(Q instanceof G){if(!Q.collection){Q.collection=this}return Q}P||(P={});P.collection=this;var O=new this.model(Q,P);if(!O._validate(Q,P)){this.trigger("invalid",this,Q,P);return false}return O},_removeReference:function(O){if(this===O.collection){delete O.collection}O.off("all",this._onModelEvent,this)},_onModelEvent:function(Q,P,R,O){if((Q==="add"||Q==="remove")&&R!==this){return}if(Q==="destroy"){this.remove(P,O)}if(P&&Q==="change:"+P.idAttribute){delete this._byId[P.previous(P.idAttribute)];if(P.id!=null){this._byId[P.id]=P}}this.trigger.apply(this,arguments)}});var A=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];N.each(A,function(O){c.prototype[O]=function(){var P=p.call(arguments);P.unshift(this.models);return N[O].apply(N,P)}});var m=["groupBy","countBy","sortBy"];N.each(m,function(O){c.prototype[O]=function(R,P){var Q=N.isFunction(R)?R:function(S){return S.get(R)};return N[O](this.models,Q,P)}});var I=B.View=function(O){this.cid=N.uniqueId("view");this._configure(O||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var x=/^(\S+)\s*(.*)$/;var e=["model","collection","el","id","attributes","className","tagName","events"];N.extend(I.prototype,L,{tagName:"div",$:function(O){return this.$el.find(O)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();this.stopListening();return this},setElement:function(O,P){if(this.$el){this.undelegateEvents()}this.$el=O instanceof B.$?O:B.$(O);this.el=this.$el[0];if(P!==false){this.delegateEvents()}return this},delegateEvents:function(S){if(!(S||(S=N.result(this,"events")))){return this}this.undelegateEvents();for(var R in S){var T=S[R];if(!N.isFunction(T)){T=this[S[R]]}if(!T){continue}var Q=R.match(x);var P=Q[1],O=Q[2];T=N.bind(T,this);P+=".delegateEvents"+this.cid;if(O===""){this.$el.on(P,T)}else{this.$el.on(P,O,T)}}return this},undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid);return this},_configure:function(O){if(this.options){O=N.extend({},N.result(this,"options"),O)}N.extend(this,N.pick(O,e));this.options=O},_ensureElement:function(){if(!this.el){var O=N.extend({},N.result(this,"attributes"));if(this.id){O.id=N.result(this,"id")}if(this.className){O["class"]=N.result(this,"className")}var P=B.$("<"+N.result(this,"tagName")+">").attr(O);this.setElement(P,false)}else{this.setElement(N.result(this,"el"),false)}}});B.sync=function(U,P,O){var R=l[U];N.defaults(O||(O={}),{emulateHTTP:B.emulateHTTP,emulateJSON:B.emulateJSON});var T={type:R,dataType:"json"};if(!O.url){T.url=N.result(P,"url")||t()}if(O.data==null&&P&&(U==="create"||U==="update"||U==="patch")){T.contentType="application/json";T.data=JSON.stringify(O.attrs||P.toJSON(O))}if(O.emulateJSON){T.contentType="application/x-www-form-urlencoded";T.data=T.data?{model:T.data}:{}}if(O.emulateHTTP&&(R==="PUT"||R==="DELETE"||R==="PATCH")){T.type="POST";if(O.emulateJSON){T.data._method=R}var Q=O.beforeSend;O.beforeSend=function(V){V.setRequestHeader("X-HTTP-Method-Override",R);if(Q){return Q.apply(this,arguments)}}}if(T.type!=="GET"&&!O.emulateJSON){T.processData=false}if(T.type==="PATCH"&&window.ActiveXObject&&!(window.external&&window.external.msActiveXFilteringEnabled)){T.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}var S=O.xhr=B.ajax(N.extend(T,O));P.trigger("request",P,S,O);return S};var l={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};B.ajax=function(){return B.$.ajax.apply(B.$,arguments)};var r=B.Router=function(O){O||(O={});if(O.routes){this.routes=O.routes}this._bindRoutes();this.initialize.apply(this,arguments)};var s=/\((.*?)\)/g;var u=/(\(\?)?:\w+/g;var d=/\*\w+/g;var h=/[\-{}\[\]+?.,\\\^$|#\s]/g;N.extend(r.prototype,L,{initialize:function(){},route:function(P,Q,R){if(!N.isRegExp(P)){P=this._routeToRegExp(P)}if(N.isFunction(Q)){R=Q;Q=""}if(!R){R=this[Q]}var O=this;B.history.route(P,function(T){var S=O._extractParameters(P,T);R&&R.apply(O,S);O.trigger.apply(O,["route:"+Q].concat(S));O.trigger("route",Q,S);B.history.trigger("route",O,Q,S)});return this},navigate:function(P,O){B.history.navigate(P,O);return this},_bindRoutes:function(){if(!this.routes){return}this.routes=N.result(this,"routes");var P,O=N.keys(this.routes);while((P=O.pop())!=null){this.route(P,this.routes[P])}},_routeToRegExp:function(O){O=O.replace(h,"\\$&").replace(s,"(?:$1)?").replace(u,function(Q,P){return P?Q:"([^/]+)"}).replace(d,"(.*?)");return new RegExp("^"+O+"$")},_extractParameters:function(O,P){var Q=O.exec(P).slice(1);return N.map(Q,function(R){return R?decodeURIComponent(R):null})}});var j=B.History=function(){this.handlers=[];N.bindAll(this,"checkUrl");if(typeof window!=="undefined"){this.location=window.location;this.history=window.history}};var C=/^[#\/]|\s+$/g;var f=/^\/+|\/+$/g;var K=/msie [\w.]+/;var o=/\/$/;j.started=false;N.extend(j.prototype,L,{interval:50,getHash:function(P){var O=(P||this).location.href.match(/#(.*)$/);return O?O[1]:""},getFragment:function(Q,P){if(Q==null){if(this._hasPushState||!this._wantsHashChange||P){Q=this.location.pathname;var O=this.root.replace(o,"");if(!Q.indexOf(O)){Q=Q.substr(O.length)}}else{Q=this.getHash()}}return Q.replace(C,"")},start:function(Q){if(j.started){throw new Error("Backbone.history has already been started")}j.started=true;this.options=N.extend({},{root:"/"},this.options,Q);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var P=this.getFragment();var O=document.documentMode;var S=(K.exec(navigator.userAgent.toLowerCase())&&(!O||O<=7));this.root=("/"+this.root+"/").replace(f,"/");if(S&&this._wantsHashChange){this.iframe=B.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow;this.navigate(P)}if(this._hasPushState){B.$(window).on("popstate",this.checkUrl)}else{if(this._wantsHashChange&&("onhashchange" in window)&&!S){B.$(window).on("hashchange",this.checkUrl)}else{if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval)}}}this.fragment=P;var T=this.location;var R=T.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!R){this.fragment=this.getFragment(null,true);this.location.replace(this.root+this.location.search+"#"+this.fragment);return true}else{if(this._wantsPushState&&this._hasPushState&&R&&T.hash){this.fragment=this.getHash().replace(C,"");this.history.replaceState({},document.title,this.root+this.fragment+T.search)}}if(!this.options.silent){return this.loadUrl()}},stop:function(){B.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);j.started=false},route:function(O,P){this.handlers.unshift({route:O,callback:P})},checkUrl:function(P){var O=this.getFragment();if(O===this.fragment&&this.iframe){O=this.getFragment(this.getHash(this.iframe))}if(O===this.fragment){return false}if(this.iframe){this.navigate(O)}this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(Q){var P=this.fragment=this.getFragment(Q);var O=N.any(this.handlers,function(R){if(R.route.test(P)){R.callback(P);return true}});return O},navigate:function(Q,P){if(!j.started){return false}if(!P||P===true){P={trigger:P}}Q=this.getFragment(Q||"");if(this.fragment===Q){return}this.fragment=Q;var O=this.root+Q;if(this._hasPushState){this.history[P.replace?"replaceState":"pushState"]({},document.title,O)}else{if(this._wantsHashChange){this._updateHash(this.location,Q,P.replace);if(this.iframe&&(Q!==this.getFragment(this.getHash(this.iframe)))){if(!P.replace){this.iframe.document.open().close()}this._updateHash(this.iframe.location,Q,P.replace)}}else{return this.location.assign(O)}}if(P.trigger){this.loadUrl(Q)}},_updateHash:function(O,Q,R){if(R){var P=O.href.replace(/(javascript:|#).*$/,"");O.replace(P+"#"+Q)}else{O.hash="#"+Q}}});B.history=new j;var n=function(O,Q){var P=this;var S;if(O&&N.has(O,"constructor")){S=O.constructor}else{S=function(){return P.apply(this,arguments)}}N.extend(S,P,Q);var R=function(){this.constructor=S};R.prototype=P.prototype;S.prototype=new R;if(O){N.extend(S.prototype,O)}S.__super__=P.prototype;return S};G.extend=c.extend=r.extend=I.extend=j.extend=n;var t=function(){throw new Error('A "url" property or function must be specified')};var J=function(Q,P){var O=P.error;P.error=function(R){if(O){O(Q,R,P)}Q.trigger("error",Q,R,P)}}}).call(this);if(!Date.prototype.setISO8601){Date.prototype.setISO8601=function(e){var a=/(\d\d\d\d)(-)?(\d\d)(-)?(\d\d)(T)?(\d\d)(:)?(\d\d)(:)?(\d\d)(\.\d+)?(Z|([+-])(\d\d)(:)?(\d\d))/;if(e.toString().match(new RegExp(a))){var c=e.match(new RegExp(a));var b=0;this.setUTCDate(1);this.setUTCFullYear(parseInt(c[1],10));this.setUTCMonth(parseInt(c[3],10)-1);this.setUTCDate(parseInt(c[5],10));this.setUTCHours(parseInt(c[7],10));this.setUTCMinutes(parseInt(c[9],10));this.setUTCSeconds(parseInt(c[11],10));if(c[12]){this.setUTCMilliseconds(parseFloat(c[12])*1000)}else{this.setUTCMilliseconds(0)}if(c[13]!="Z"){b=(c[15]*60)+parseInt(c[17],10);b*=((c[14]=="-")?-1:1);this.setTime(this.getTime()-b*60*1000)}}else{this.setTime(Date.parse(e))}return this}}var Base64=(function(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var b={encode:function(e){var c="";var n,l,h;var m,j,g,f;var d=0;do{n=e.charCodeAt(d++);l=e.charCodeAt(d++);h=e.charCodeAt(d++);m=n>>2;j=((n&3)<<4)|(l>>4);g=((l&15)<<2)|(h>>6);f=h&63;if(isNaN(l)){g=f=64}else{if(isNaN(h)){f=64}}c=c+a.charAt(m)+a.charAt(j)+a.charAt(g)+a.charAt(f)}while(d<e.length);return c},decode:function(e){var c="";var n,l,h;var m,j,g,f;var d=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{m=a.indexOf(e.charAt(d++));j=a.indexOf(e.charAt(d++));g=a.indexOf(e.charAt(d++));f=a.indexOf(e.charAt(d++));n=(m<<2)|(j>>4);l=((j&15)<<4)|(g>>2);h=((g&3)<<6)|f;c=c+String.fromCharCode(n);if(g!=64){c=c+String.fromCharCode(l)}if(f!=64){c=c+String.fromCharCode(h)}}while(d<e.length);return c}};return b})();var MD5=(function(){var q=0;var a="";var n=8;var l=function(t,w){var v=(t&65535)+(w&65535);var u=(t>>16)+(w>>16)+(v>>16);return(u<<16)|(v&65535)};var p=function(t,u){return(t<<u)|(t>>>(32-u))};var b=function(w){var v=[];var t=(1<<n)-1;for(var u=0;u<w.length*n;u+=n){v[u>>5]|=(w.charCodeAt(u/n)&t)<<(u%32)}return v};var g=function(v){var w="";var t=(1<<n)-1;for(var u=0;u<v.length*32;u+=n){w+=String.fromCharCode((v[u>>5]>>>(u%32))&t)}return w};var s=function(v){var u=q?"0123456789ABCDEF":"0123456789abcdef";var w="";for(var t=0;t<v.length*4;t++){w+=u.charAt((v[t>>2]>>((t%4)*8+4))&15)+u.charAt((v[t>>2]>>((t%4)*8))&15)}return w};var r=function(w){var v="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var y="";var x,t;for(var u=0;u<w.length*4;u+=3){x=(((w[u>>2]>>8*(u%4))&255)<<16)|(((w[u+1>>2]>>8*((u+1)%4))&255)<<8)|((w[u+2>>2]>>8*((u+2)%4))&255);for(t=0;t<4;t++){if(u*8+t*6>w.length*32){y+=a}else{y+=v.charAt((x>>6*(3-t))&63)}}}return y};var d=function(A,w,v,u,z,y){return l(p(l(l(w,A),l(u,y)),z),v)};var m=function(w,v,B,A,u,z,y){return d((v&B)|((~v)&A),w,v,u,z,y)};var c=function(w,v,B,A,u,z,y){return d((v&A)|(B&(~A)),w,v,u,z,y)};var o=function(w,v,B,A,u,z,y){return d(v^B^A,w,v,u,z,y)};var j=function(w,v,B,A,u,z,y){return d(B^(v|(~A)),w,v,u,z,y)};var f=function(E,z){E[z>>5]|=128<<((z)%32);E[(((z+64)>>>9)<<4)+14]=z;var D=1732584193;var C=-271733879;var B=-1732584194;var A=271733878;var y,w,v,t;for(var u=0;u<E.length;u+=16){y=D;w=C;v=B;t=A;D=m(D,C,B,A,E[u+0],7,-680876936);A=m(A,D,C,B,E[u+1],12,-389564586);B=m(B,A,D,C,E[u+2],17,606105819);C=m(C,B,A,D,E[u+3],22,-1044525330);D=m(D,C,B,A,E[u+4],7,-176418897);A=m(A,D,C,B,E[u+5],12,1200080426);B=m(B,A,D,C,E[u+6],17,-1473231341);C=m(C,B,A,D,E[u+7],22,-45705983);D=m(D,C,B,A,E[u+8],7,1770035416);A=m(A,D,C,B,E[u+9],12,-1958414417);B=m(B,A,D,C,E[u+10],17,-42063);C=m(C,B,A,D,E[u+11],22,-1990404162);D=m(D,C,B,A,E[u+12],7,1804603682);A=m(A,D,C,B,E[u+13],12,-40341101);B=m(B,A,D,C,E[u+14],17,-1502002290);C=m(C,B,A,D,E[u+15],22,1236535329);D=c(D,C,B,A,E[u+1],5,-165796510);A=c(A,D,C,B,E[u+6],9,-1069501632);B=c(B,A,D,C,E[u+11],14,643717713);C=c(C,B,A,D,E[u+0],20,-373897302);D=c(D,C,B,A,E[u+5],5,-701558691);A=c(A,D,C,B,E[u+10],9,38016083);B=c(B,A,D,C,E[u+15],14,-660478335);C=c(C,B,A,D,E[u+4],20,-405537848);D=c(D,C,B,A,E[u+9],5,568446438);A=c(A,D,C,B,E[u+14],9,-1019803690);B=c(B,A,D,C,E[u+3],14,-187363961);C=c(C,B,A,D,E[u+8],20,1163531501);D=c(D,C,B,A,E[u+13],5,-1444681467);A=c(A,D,C,B,E[u+2],9,-51403784);B=c(B,A,D,C,E[u+7],14,1735328473);C=c(C,B,A,D,E[u+12],20,-1926607734);D=o(D,C,B,A,E[u+5],4,-378558);A=o(A,D,C,B,E[u+8],11,-2022574463);B=o(B,A,D,C,E[u+11],16,1839030562);C=o(C,B,A,D,E[u+14],23,-35309556);D=o(D,C,B,A,E[u+1],4,-1530992060);A=o(A,D,C,B,E[u+4],11,1272893353);B=o(B,A,D,C,E[u+7],16,-155497632);C=o(C,B,A,D,E[u+10],23,-1094730640);D=o(D,C,B,A,E[u+13],4,681279174);A=o(A,D,C,B,E[u+0],11,-358537222);B=o(B,A,D,C,E[u+3],16,-722521979);C=o(C,B,A,D,E[u+6],23,76029189);D=o(D,C,B,A,E[u+9],4,-640364487);A=o(A,D,C,B,E[u+12],11,-421815835);B=o(B,A,D,C,E[u+15],16,530742520);C=o(C,B,A,D,E[u+2],23,-995338651);D=j(D,C,B,A,E[u+0],6,-198630844);A=j(A,D,C,B,E[u+7],10,1126891415);B=j(B,A,D,C,E[u+14],15,-1416354905);C=j(C,B,A,D,E[u+5],21,-57434055);D=j(D,C,B,A,E[u+12],6,1700485571);A=j(A,D,C,B,E[u+3],10,-1894986606);B=j(B,A,D,C,E[u+10],15,-1051523);C=j(C,B,A,D,E[u+1],21,-2054922799);D=j(D,C,B,A,E[u+8],6,1873313359);A=j(A,D,C,B,E[u+15],10,-30611744);B=j(B,A,D,C,E[u+6],15,-1560198380);C=j(C,B,A,D,E[u+13],21,1309151649);D=j(D,C,B,A,E[u+4],6,-145523070);A=j(A,D,C,B,E[u+11],10,-1120210379);B=j(B,A,D,C,E[u+2],15,718787259);C=j(C,B,A,D,E[u+9],21,-343485551);D=l(D,y);C=l(C,w);B=l(B,v);A=l(A,t)}return[D,C,B,A]};var e=function(v,y){var x=b(v);if(x.length>16){x=f(x,v.length*n)}var t=new Array(16),w=new Array(16);for(var u=0;u<16;u++){t[u]=x[u]^909522486;w[u]=x[u]^1549556828}var z=f(t.concat(b(y)),512+y.length*n);return f(w.concat(z),512+128)};var h={hexdigest:function(t){return s(f(b(t),t.length*n))},b64digest:function(t){return r(f(b(t),t.length*n))},hash:function(t){return g(f(b(t),t.length*n))},hmac_hexdigest:function(t,u){return s(e(t,u))},hmac_b64digest:function(t,u){return r(e(t,u))},hmac_hash:function(t,u){return g(e(t,u))},test:function(){return MD5.hexdigest("abc")==="900150983cd24fb0d6963f7d28e17f72"}};return h})();if(!Function.prototype.bind){Function.prototype.bind=function(e){var d=this;var c=Array.prototype.slice;var b=Array.prototype.concat;var a=c.call(arguments,1);return function(){return d.apply(e?e:this,b.call(a,c.call(arguments,0)))}}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(b){var a=this.length;var c=Number(arguments[1])||0;c=(c<0)?Math.ceil(c):Math.floor(c);if(c<0){c+=a}for(;c<a;c++){if(c in this&&this[c]===b){return c}}return -1}}(function(f){var e;function c(h,g){return new e.Builder(h,g)}function a(g){return new e.Builder("message",g)}function d(g){return new e.Builder("iq",g)}function b(g){return new e.Builder("presence",g)}e={VERSION:"@VERSION@",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(g){for(var h=0;h<e.XHTML.tags.length;h++){if(g==e.XHTML.tags[h]){return true}}return false},validAttribute:function(g,j){if(typeof e.XHTML.attributes[g]!=="undefined"&&e.XHTML.attributes[g].length>0){for(var h=0;h<e.XHTML.attributes[g].length;h++){if(j==e.XHTML.attributes[g][h]){return true}}}return false},validCSS:function(h){for(var g=0;g<e.XHTML.css.length;g++){if(h==e.XHTML.css[g]){return true}}return false}},addNamespace:function(g,h){e.NS[g]=h},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,forEachChild:function(l,m,j){var h,g;for(h=0;h<l.childNodes.length;h++){g=l.childNodes[h];if(g.nodeType==e.ElementType.NORMAL&&(!m||this.isTagEqual(g,m))){j(g)}}},isTagEqual:function(h,g){return h.tagName.toLowerCase()==g.toLowerCase()},_xmlGenerator:null,_makeGenerator:function(){var g;if(document.implementation.createDocument===undefined||document.implementation.createDocument&&document.documentMode&&document.documentMode<10){g=this._getIEXmlDom();g.appendChild(g.createElement("strophe"))}else{g=document.implementation.createDocument("jabber:client","strophe",null)}return g},xmlGenerator:function(){if(!e._xmlGenerator){e._xmlGenerator=e._makeGenerator()}return e._xmlGenerator},_getIEXmlDom:function(){var h=null;var l=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"];for(var j=0;j<l.length;j++){if(h===null){try{h=new ActiveXObject(l[j])}catch(g){h=null}}else{break}}return h},xmlElement:function(j){if(!j){return null}var m=e.xmlGenerator().createElement(j);var g,l,h;for(g=1;g<arguments.length;g++){if(!arguments[g]){continue}if(typeof(arguments[g])=="string"||typeof(arguments[g])=="number"){m.appendChild(e.xmlTextNode(arguments[g]))}else{if(typeof(arguments[g])=="object"&&typeof(arguments[g].sort)=="function"){for(l=0;l<arguments[g].length;l++){if(typeof(arguments[g][l])=="object"&&typeof(arguments[g][l].sort)=="function"){m.setAttribute(arguments[g][l][0],arguments[g][l][1])}}}else{if(typeof(arguments[g])=="object"){for(h in arguments[g]){if(arguments[g].hasOwnProperty(h)){m.setAttribute(h,arguments[g][h])}}}}}}return m},xmlescape:function(g){g=g.replace(/\&/g,"&amp;");g=g.replace(/</g,"&lt;");g=g.replace(/>/g,"&gt;");g=g.replace(/'/g,"&apos;");g=g.replace(/"/g,"&quot;");return g},xmlTextNode:function(g){return e.xmlGenerator().createTextNode(g)},xmlHtmlNode:function(g){if(window.DOMParser){parser=new DOMParser();node=parser.parseFromString(g,"text/xml")}else{node=new ActiveXObject("Microsoft.XMLDOM");node.async="false";node.loadXML(g)}return node},getText:function(h){if(!h){return null}var j="";if(h.childNodes.length===0&&h.nodeType==e.ElementType.TEXT){j+=h.nodeValue}for(var g=0;g<h.childNodes.length;g++){if(h.childNodes[g].nodeType==e.ElementType.TEXT){j+=h.childNodes[g].nodeValue}}return e.xmlescape(j)},copyElement:function(j){var g,h;if(j.nodeType==e.ElementType.NORMAL){h=e.xmlElement(j.tagName);for(g=0;g<j.attributes.length;g++){h.setAttribute(j.attributes[g].nodeName.toLowerCase(),j.attributes[g].value)}for(g=0;g<j.childNodes.length;g++){h.appendChild(e.copyElement(j.childNodes[g]))}}else{if(j.nodeType==e.ElementType.TEXT){h=e.xmlGenerator().createTextNode(j.nodeValue)}}return h},createHtml:function(n){var q,m,o,x,l,w,s,t,v,p,r,h,g;if(n.nodeType==e.ElementType.NORMAL){x=n.nodeName.toLowerCase();if(e.XHTML.validTag(x)){try{m=e.xmlElement(x);for(q=0;q<e.XHTML.attributes[x].length;q++){l=e.XHTML.attributes[x][q];w=n.getAttribute(l);if(typeof w=="undefined"||w===null||w===""||w===false||w===0){continue}if(l=="style"&&typeof w=="object"){if(typeof w.cssText!="undefined"){w=w.cssText}}if(l=="style"){s=[];t=w.split(";");for(o=0;o<t.length;o++){v=t[o].split(":");p=v[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase();if(e.XHTML.validCSS(p)){r=v[1].replace(/^\s*/,"").replace(/\s*$/,"");s.push(p+": "+r)}}if(s.length>0){w=s.join("; ");m.setAttribute(l,w)}}else{m.setAttribute(l,w)}}for(q=0;q<n.childNodes.length;q++){m.appendChild(e.createHtml(n.childNodes[q]))}}catch(u){m=e.xmlTextNode("")}}else{m=e.xmlGenerator().createDocumentFragment();for(q=0;q<n.childNodes.length;q++){m.appendChild(e.createHtml(n.childNodes[q]))}}}else{if(n.nodeType==e.ElementType.FRAGMENT){m=e.xmlGenerator().createDocumentFragment();for(q=0;q<n.childNodes.length;q++){m.appendChild(e.createHtml(n.childNodes[q]))}}else{if(n.nodeType==e.ElementType.TEXT){m=e.xmlTextNode(n.nodeValue)}}}return m},escapeNode:function(g){return g.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(g){return g.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(g){if(g.indexOf("@")<0){return null}return g.split("@")[0]},getDomainFromJid:function(g){var h=e.getBareJidFromJid(g);if(h.indexOf("@")<0){return h}else{var j=h.split("@");j.splice(0,1);return j.join("@")}},getResourceFromJid:function(g){var h=g.split("/");if(h.length<2){return null}h.splice(0,1);return h.join("/")},getBareJidFromJid:function(g){return g?g.split("/")[0]:null},log:function(h,g){return},debug:function(g){this.log(this.LogLevel.DEBUG,g)},info:function(g){this.log(this.LogLevel.INFO,g)},warn:function(g){this.log(this.LogLevel.WARN,g)},error:function(g){this.log(this.LogLevel.ERROR,g)},fatal:function(g){this.log(this.LogLevel.FATAL,g)},serialize:function(j){var g;if(!j){return null}if(typeof(j.tree)==="function"){j=j.tree()}var m=j.nodeName;var h,l;if(j.getAttribute("_realname")){m=j.getAttribute("_realname")}g="<"+m;for(h=0;h<j.attributes.length;h++){if(j.attributes[h].nodeName!="_realname"){g+=" "+j.attributes[h].nodeName.toLowerCase()+"='"+j.attributes[h].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/>/g,"&gt;").replace(/</g,"&lt;")+"'"}}if(j.childNodes.length>0){g+=">";for(h=0;h<j.childNodes.length;h++){l=j.childNodes[h];switch(l.nodeType){case e.ElementType.NORMAL:g+=e.serialize(l);break;case e.ElementType.TEXT:g+=e.xmlescape(l.nodeValue);break;case e.ElementType.CDATA:g+="<![CDATA["+l.nodeValue+"]]>"}}g+="</"+m+">"}else{g+="/>"}return g},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(g,h){e._connectionPlugins[g]=h}};e.Builder=function(h,g){if(h=="presence"||h=="message"||h=="iq"){if(g&&!g.xmlns){g.xmlns=e.NS.CLIENT}else{if(!g){g={xmlns:e.NS.CLIENT}}}}this.nodeTree=e.xmlElement(h,g);this.node=this.nodeTree};e.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return e.serialize(this.nodeTree)},up:function(){this.node=this.node.parentNode;return this},attrs:function(h){for(var g in h){if(h.hasOwnProperty(g)){this.node.setAttribute(g,h[g])}}return this},c:function(h,g,j){var l=e.xmlElement(h,g,j);this.node.appendChild(l);if(!j){this.node=l}return this},cnode:function(j){var m=e.xmlGenerator();try{var h=(m.importNode!==undefined)}catch(l){var h=false}var g=h?m.importNode(j,true):e.copyElement(j);this.node.appendChild(g);this.node=g;return this},t:function(g){var h=e.xmlTextNode(g);this.node.appendChild(h);return this},h:function(h){var g=document.createElement("body");g.innerHTML=h;var j=e.createHtml(g);while(j.childNodes.length>0){this.node.appendChild(j.childNodes[0])}return this}};e.Handler=function(m,l,h,j,o,n,g){this.handler=m;this.ns=l;this.name=h;this.type=j;this.id=o;this.options=g||{matchBare:false};if(!this.options.matchBare){this.options.matchBare=false}if(this.options.matchBare){this.from=n?e.getBareJidFromJid(n):null}else{this.from=n}this.user=true};e.Handler.prototype={isMatch:function(h){var l;var j=null;if(this.options.matchBare){j=e.getBareJidFromJid(h.getAttribute("from"))}else{j=h.getAttribute("from")}l=false;if(!this.ns){l=true}else{var g=this;e.forEachChild(h,null,function(m){if(m.getAttribute("xmlns")==g.ns){l=true}});l=l||h.getAttribute("xmlns")==this.ns}if(l&&(!this.name||e.isTagEqual(h,this.name))&&(!this.type||h.getAttribute("type")==this.type)&&(!this.id||h.getAttribute("id")==this.id)&&(!this.from||j==this.from)){return true}return false},run:function(h){var g=null;try{g=this.handler(h)}catch(j){if(j.sourceURL){e.fatal("error: "+this.handler+" "+j.sourceURL+":"+j.line+" - "+j.name+": "+j.message)}else{if(j.fileName){if(typeof(console)!="undefined"){console.trace();console.error(this.handler," - error - ",j,j.message)}e.fatal("error: "+this.handler+" "+j.fileName+":"+j.lineNumber+" - "+j.name+": "+j.message)}else{e.fatal("error: "+j.message+"\n"+j.stack)}}throw j}return g},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};e.TimedHandler=function(h,g){this.period=h;this.handler=g;this.lastCalled=new Date().getTime();this.user=true};e.TimedHandler.prototype={run:function(){this.lastCalled=new Date().getTime();return this.handler()},reset:function(){this.lastCalled=new Date().getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};e.Request=function(j,h,g,l){this.id=++e._requestId;this.xmlData=j;this.data=e.serialize(j);this.origFunc=h;this.func=h;this.rid=g;this.date=NaN;this.sends=l||0;this.abort=false;this.dead=null;this.age=function(){if(!this.date){return 0}var m=new Date();return(m-this.date)/1000};this.timeDead=function(){if(!this.dead){return 0}var m=new Date();return(m-this.dead)/1000};this.xhr=this._newXHR()};e.Request.prototype={getResponse:function(){var g=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){g=this.xhr.responseXML.documentElement;if(g.tagName=="parsererror"){e.error("invalid response received");e.error("responseText: "+this.xhr.responseText);e.error("responseXML: "+e.serialize(this.xhr.responseXML));throw"parsererror"}}else{if(this.xhr.responseText){e.error("invalid response received");e.error("responseText: "+this.xhr.responseText);e.error("responseXML: "+e.serialize(this.xhr.responseXML))}}return g},_newXHR:function(){var g=null;if(window.XMLHttpRequest){g=new XMLHttpRequest();if(g.overrideMimeType){g.overrideMimeType("text/xml")}}else{if(window.ActiveXObject){g=new ActiveXObject("Microsoft.XMLHTTP")}}g.onreadystatechange=this.func.bind(null,this);return g}};e.Connection=function(g){this.service=g;this.jid="";this.domain=null;this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.streamId=null;this.features=null;this._sasl_data=[];this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this._idleTimeout=null;this._disconnectTimeout=null;this.do_authentication=true;this.authenticated=false;this.disconnecting=false;this.connected=false;this.errors=0;this.paused=false;this.hold=1;this.wait=60;this.window=5;this._data=[];this._requests=[];this._uniqueId=Math.round(Math.random()*10000);this._sasl_success_handler=null;this._sasl_failure_handler=null;this._sasl_challenge_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(this._onIdle.bind(this),100);for(var h in e._connectionPlugins){if(e._connectionPlugins.hasOwnProperty(h)){var l=e._connectionPlugins[h];var j=function(){};j.prototype=l;this[h]=new j();this[h].init(this)}}};e.Connection.prototype={reset:function(){this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.streamId=null;this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this.authenticated=false;this.disconnecting=false;this.connected=false;this.errors=0;this._requests=[];this._uniqueId=Math.round(Math.random()*10000)},pause:function(){this.paused=true},resume:function(){this.paused=false},getUniqueId:function(g){if(typeof(g)=="string"||typeof(g)=="number"){return ++this._uniqueId+":"+g}else{return ++this._uniqueId+""}},connect:function(j,m,p,o,n,h){this.jid=j;this.pass=m;this.connect_callback=p;this.disconnecting=false;this.connected=false;this.authenticated=false;this.errors=0;this.wait=o||this.wait;this.hold=n||this.hold;this.domain=this.domain||e.getDomainFromJid(this.jid);var g=this._buildBody().attrs({to:this.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":e.NS.BOSH});if(h){g.attrs({route:h})}this._changeConnectStatus(e.Status.CONNECTING,null);var l=this._connect_callback||this._connect_cb;this._connect_callback=null;this._requests.push(new e.Request(g.tree(),this._onRequestStateChange.bind(this,l.bind(this)),g.tree().getAttribute("rid")));this._throttledRequestHandler()},attach:function(j,g,l,o,n,m,h){this.jid=j;this.sid=g;this.rid=l;this.connect_callback=o;this.domain=e.getDomainFromJid(this.jid);this.authenticated=true;this.connected=true;this.wait=n||this.wait;this.hold=m||this.hold;this.window=h||this.window;this._changeConnectStatus(e.Status.ATTACHED,null)},xmlInput:function(g){return},xmlOutput:function(g){return},rawInput:function(g){return},rawOutput:function(g){return},send:function(h){if(h===null){return}if(typeof(h.sort)==="function"){for(var g=0;g<h.length;g++){this._queueData(h[g])}}else{if(typeof(h.tree)==="function"){this._queueData(h.tree())}else{this._queueData(h)}}this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(l,p,g,m){var n=null;var j=this;if(typeof(l.tree)==="function"){l=l.tree()}var o=l.getAttribute("id");if(!o){o=this.getUniqueId("sendIQ");l.setAttribute("id",o)}var h=this.addHandler(function(r){if(n){j.deleteTimedHandler(n)}var q=r.getAttribute("type");if(q=="result"){if(p){p(r)}}else{if(q=="error"){if(g){g(r)}}else{throw {name:"StropheError",message:"Got bad IQ type of "+q}}}},null,"iq",null,o);if(m){n=this.addTimedHandler(m,function(){j.deleteHandler(h);if(g){g(null)}return false})}this.send(l);return o},_queueData:function(g){if(g===null||!g.tagName||!g.childNodes){throw {name:"StropheError",message:"Cannot queue non-DOMElement."}}this._data.push(g)},_sendRestart:function(){this._data.push("restart");this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},addTimedHandler:function(j,h){var g=new e.TimedHandler(j,h);this.addTimeds.push(g);return g},deleteTimedHandler:function(g){this.removeTimeds.push(g)},addHandler:function(n,m,j,l,p,o,h){var g=new e.Handler(n,m,j,l,p,o,h);this.addHandlers.push(g);return g},deleteHandler:function(g){this.removeHandlers.push(g)},disconnect:function(g){this._changeConnectStatus(e.Status.DISCONNECTING,g);e.info("Disconnect was called because: "+g);if(this.connected){this._disconnectTimeout=this._addSysTimedHandler(3000,this._onDisconnectTimeout.bind(this));this._sendTerminate()}},_changeConnectStatus:function(g,n){for(var h in e._connectionPlugins){if(e._connectionPlugins.hasOwnProperty(h)){var l=this[h];if(l.statusChanged){try{l.statusChanged(g,n)}catch(j){e.error(""+h+" plugin caused an exception changing status: "+j)}}}}if(this.connect_callback){try{this.connect_callback(g,n)}catch(m){e.error("User connection callback caused an exception: "+m)}}},_buildBody:function(){var g=c("body",{rid:this.rid++,xmlns:e.NS.HTTPBIND});if(this.sid!==null){g.attrs({sid:this.sid})}return g},_removeRequest:function(h){e.debug("removing request");var g;for(g=this._requests.length-1;g>=0;g--){if(h==this._requests[g]){this._requests.splice(g,1)}}h.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(g){var h=this._requests[g];if(h.dead===null){h.dead=new Date()}this._processRequest(g)},_processRequest:function(j){var p=this._requests[j];var s=-1;try{if(p.xhr.readyState==4){s=p.xhr.status}}catch(n){e.error("caught an error in _requests["+j+"], reqStatus: "+s)}if(typeof(s)=="undefined"){s=-1}if(p.sends>this.maxRetries){this._onDisconnectTimeout();return}var h=p.age();var g=(!isNaN(h)&&h>Math.floor(e.TIMEOUT*this.wait));var l=(p.dead!==null&&p.timeDead()>Math.floor(e.SECONDARY_TIMEOUT*this.wait));var r=(p.xhr.readyState==4&&(s<1||s>=500));if(g||l||r){if(l){e.error("Request "+this._requests[j].id+" timed out (secondary), restarting")}p.abort=true;p.xhr.abort();p.xhr.onreadystatechange=function(){};this._requests[j]=new e.Request(p.xmlData,p.origFunc,p.rid,p.sends);p=this._requests[j]}if(p.xhr.readyState===0){e.debug("request id "+p.id+"."+p.sends+" posting");try{p.xhr.open("POST",this.service,true)}catch(o){e.error("XHR open failed.");if(!this.connected){this._changeConnectStatus(e.Status.CONNFAIL,"bad-service")}this.disconnect();return}var q=function(){p.date=new Date();p.xhr.send(p.data)};if(p.sends>1){var m=Math.min(Math.floor(e.TIMEOUT*this.wait),Math.pow(p.sends,3))*1000;setTimeout(q,m)}else{q()}p.sends++;if(this.xmlOutput!==e.Connection.prototype.xmlOutput){this.xmlOutput(p.xmlData)}if(this.rawOutput!==e.Connection.prototype.rawOutput){this.rawOutput(p.data)}}else{e.debug("_processRequest: "+(j===0?"first":"second")+" request has readyState of "+p.xhr.readyState)}},_throttledRequestHandler:function(){if(!this._requests){e.debug("_throttledRequestHandler called with undefined requests")}else{e.debug("_throttledRequestHandler called with "+this._requests.length+" requests")}if(!this._requests||this._requests.length===0){return}if(this._requests.length>0){this._processRequest(0)}if(this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window){this._processRequest(1)}},_onRequestStateChange:function(l,j){e.debug("request id "+j.id+"."+j.sends+" state changed to "+j.xhr.readyState);if(j.abort){j.abort=false;return}var h;if(j.xhr.readyState==4){h=0;try{h=j.xhr.status}catch(m){}if(typeof(h)=="undefined"){h=0}if(this.disconnecting){if(h>=400){this._hitError(h);return}}var g=(this._requests[0]==j);var n=(this._requests[1]==j);if((h>0&&h<500)||j.sends>5){this._removeRequest(j);e.debug("request id "+j.id+" should now be removed")}if(h==200){if(n||(g&&this._requests.length>0&&this._requests[0].age()>Math.floor(e.SECONDARY_TIMEOUT*this.wait))){this._restartRequest(0)}e.debug("request id "+j.id+"."+j.sends+" got 200");l(j);this.errors=0}else{e.error("request id "+j.id+"."+j.sends+" error "+h+" happened");if(h===0||(h>=400&&h<600)||h>=12000){this._hitError(h);if(h>=400&&h<500){this._changeConnectStatus(e.Status.DISCONNECTING,null);this._doDisconnect()}}}if(!((h>0&&h<500)||j.sends>5)){this._throttledRequestHandler()}}},_hitError:function(g){this.errors++;e.warn("request errored, status: "+g+", number of errors: "+this.errors);if(this.errors>4){this._onDisconnectTimeout()}},_doDisconnect:function(){e.info("_doDisconnect was called");this.authenticated=false;this.disconnecting=false;this.sid=null;this.streamId=null;this.rid=Math.floor(Math.random()*4294967295);if(this.connected){this._changeConnectStatus(e.Status.DISCONNECTED,null);this.connected=false}this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[]},_dataRecv:function(q){try{var g=q.getResponse()}catch(o){if(o!="parsererror"){throw o}this.disconnect("strophe-parsererror")}if(g===null){return}if(this.xmlInput!==e.Connection.prototype.xmlInput){this.xmlInput(g)}if(this.rawInput!==e.Connection.prototype.rawInput){this.rawInput(e.serialize(g))}var m,j;while(this.removeHandlers.length>0){j=this.removeHandlers.pop();m=this.handlers.indexOf(j);if(m>=0){this.handlers.splice(m,1)}}while(this.addHandlers.length>0){this.handlers.push(this.addHandlers.pop())}if(this.disconnecting&&this._requests.length===0){this.deleteTimedHandler(this._disconnectTimeout);this._disconnectTimeout=null;this._doDisconnect();return}var h=g.getAttribute("type");var p,l;if(h!==null&&h=="terminate"){if(this.disconnecting){return}p=g.getAttribute("condition");l=g.getElementsByTagName("conflict");if(p!==null){if(p=="remote-stream-error"&&l.length>0){p="conflict"}this._changeConnectStatus(e.Status.CONNFAIL,p)}else{this._changeConnectStatus(e.Status.CONNFAIL,"unknown")}this.disconnect();return}var n=this;e.forEachChild(g,null,function(v){var s,t;t=n.handlers;n.handlers=[];for(s=0;s<t.length;s++){var r=t[s];try{if(r.isMatch(v)&&(n.authenticated||!r.user)){if(r.run(v)){n.handlers.push(r)}}else{n.handlers.push(r)}}catch(u){}}})},_sendTerminate:function(){e.info("_sendTerminate was called");var g=this._buildBody().attrs({type:"terminate"});if(this.authenticated){g.c("presence",{xmlns:e.NS.CLIENT,type:"unavailable"})}this.disconnecting=true;var h=new e.Request(g.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),g.tree().getAttribute("rid"));this._requests.push(h);this._throttledRequestHandler()},_connect_cb:function(g,n){e.info("_connect_cb was called");this.connected=true;var y=g.getResponse();if(!y){return}if(this.xmlInput!==e.Connection.prototype.xmlInput){this.xmlInput(y)}if(this.rawInput!==e.Connection.prototype.rawInput){this.rawInput(e.serialize(y))}var z=y.getAttribute("type");var p,u;if(z!==null&&z=="terminate"){p=y.getAttribute("condition");u=y.getElementsByTagName("conflict");if(p!==null){if(p=="remote-stream-error"&&u.length>0){p="conflict"}this._changeConnectStatus(e.Status.CONNFAIL,p)}else{this._changeConnectStatus(e.Status.CONNFAIL,"unknown")}return}if(!this.sid){this.sid=y.getAttribute("sid")}if(!this.stream_id){this.stream_id=y.getAttribute("authid")}var h=y.getAttribute("requests");if(h){this.window=parseInt(h,10)}var r=y.getAttribute("hold");if(r){this.hold=parseInt(r,10)}var v=y.getAttribute("wait");if(v){this.wait=parseInt(v,10)}this._authentication.sasl_scram_sha1=false;this._authentication.sasl_plain=false;this._authentication.sasl_digest_md5=false;this._authentication.sasl_anonymous=false;this._authentication.legacy_auth=false;var w=y.getElementsByTagName("stream:features").length>0;if(!w){w=y.getElementsByTagName("features").length>0}var q=y.getElementsByTagName("mechanism");var x,t,j,l,s=false;if(w&&q.length>0){var m=0;for(x=0;x<q.length;x++){t=e.getText(q[x]);if(t=="SCRAM-SHA-1"){this._authentication.sasl_scram_sha1=true}else{if(t=="DIGEST-MD5"){this._authentication.sasl_digest_md5=true}else{if(t=="PLAIN"){this._authentication.sasl_plain=true}else{if(t=="ANONYMOUS"){this._authentication.sasl_anonymous=true}else{m++}}}}}this._authentication.legacy_auth=y.getElementsByTagName("auth").length>0;s=this._authentication.legacy_auth||m<q.length}if(!s){n=n||this._connect_cb;var o=this._buildBody();this._requests.push(new e.Request(o.tree(),this._onRequestStateChange.bind(this,n.bind(this)),o.tree().getAttribute("rid")));this._throttledRequestHandler();return}if(this.do_authentication!==false){this.authenticate()}},authenticate:function(){if(e.getNodeFromJid(this.jid)===null&&this._authentication.sasl_anonymous){this._changeConnectStatus(e.Status.AUTHENTICATING,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(c("auth",{xmlns:e.NS.SASL,mechanism:"ANONYMOUS"}).tree())}else{if(e.getNodeFromJid(this.jid)===null){this._changeConnectStatus(e.Status.CONNFAIL,"x-strophe-bad-non-anon-jid");this.disconnect()}else{if(this._authentication.sasl_scram_sha1){var h=MD5.hexdigest(Math.random()*1234567890);var g="n="+e.getNodeFromJid(this.jid);g+=",r=";g+=h;this._sasl_data.cnonce=h;this._sasl_data["client-first-message-bare"]=g;g="n,,"+g;this._changeConnectStatus(e.Status.AUTHENTICATING,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_scram_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(c("auth",{xmlns:e.NS.SASL,mechanism:"SCRAM-SHA-1"}).t(Base64.encode(g)).tree())}else{if(this._authentication.sasl_digest_md5){this._changeConnectStatus(e.Status.AUTHENTICATING,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_digest_challenge1_cb.bind(this),null,"challenge",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(c("auth",{xmlns:e.NS.SASL,mechanism:"DIGEST-MD5"}).tree())}else{if(this._authentication.sasl_plain){g=e.getBareJidFromJid(this.jid);g=g+"\u0000";g=g+e.getNodeFromJid(this.jid);g=g+"\u0000";g=g+this.pass;this._changeConnectStatus(e.Status.AUTHENTICATING,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);hashed_auth_str=Base64.encode(g);this.send(c("auth",{xmlns:e.NS.SASL,mechanism:"PLAIN"}).t(hashed_auth_str).tree())}else{this._changeConnectStatus(e.Status.AUTHENTICATING,null);this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1");this.send(d({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:e.NS.AUTH}).c("username",{}).t(e.getNodeFromJid(this.jid)).tree())}}}}}},_sasl_digest_challenge1_cb:function(m){var h=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/;var s=Base64.decode(e.getText(m));var t=MD5.hexdigest(""+(Math.random()*1234567890));var p="";var u=null;var q="";var g="";var o;this.deleteHandler(this._sasl_failure_handler);while(s.match(h)){o=s.match(h);s=s.replace(o[0],"");o[2]=o[2].replace(/^"(.+)"$/,"$1");switch(o[1]){case"realm":p=o[2];break;case"nonce":q=o[2];break;case"qop":g=o[2];break;case"host":u=o[2];break}}var n="xmpp/"+this.domain;if(u!==null){n=n+"/"+u}var l=MD5.hash(e.getNodeFromJid(this.jid)+":"+p+":"+this.pass)+":"+q+":"+t;var j="AUTHENTICATE:"+n;var r="";r+="username="+this._quote(e.getNodeFromJid(this.jid))+",";r+="realm="+this._quote(p)+",";r+="nonce="+this._quote(q)+",";r+="cnonce="+this._quote(t)+",";r+='nc="00000001",';r+='qop="auth",';r+="digest-uri="+this._quote(n)+",";r+="response="+this._quote(MD5.hexdigest(MD5.hexdigest(l)+":"+q+":00000001:"+t+":auth:"+MD5.hexdigest(j)))+",";r+='charset="utf-8"';this._sasl_challenge_handler=this._addSysHandler(this._sasl_digest_challenge2_cb.bind(this),null,"challenge",null,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(c("response",{xmlns:e.NS.SASL}).t(Base64.encode(r)).tree());return false},_quote:function(g){return'"'+g.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},_sasl_digest_challenge2_cb:function(g){this.deleteHandler(this._sasl_success_handler);this.deleteHandler(this._sasl_failure_handler);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(c("response",{xmlns:e.NS.SASL}).tree());return false},_sasl_scram_challenge_cb:function(j){var q,o,s,n,l,g;var p,w,m;var r="c=biws,";var t=Base64.decode(e.getText(j));var u=this._sasl_data["client-first-message-bare"]+","+t+",";var v=this._sasl_data.cnonce;var h=/([a-z]+)=([^,]+)(,|$)/;this.deleteHandler(this._sasl_failure_handler);while(t.match(h)){matches=t.match(h);t=t.replace(matches[0],"");switch(matches[1]){case"r":q=matches[2];break;case"s":o=matches[2];break;case"i":s=matches[2];break}}if(!(q.substr(0,v.length)===v)){this._sasl_data=[];return this._sasl_failure_cb(null)}r+="r="+q;u+=r;o=Base64.decode(o);o+="\0\0\0\1";n=g=core_hmac_sha1(this.pass,o);for(i=1;i<s;i++){l=core_hmac_sha1(this.pass,binb2str(g));for(k=0;k<5;k++){n[k]^=l[k]}g=l}n=binb2str(n);p=core_hmac_sha1(n,"Client Key");w=str_hmac_sha1(n,"Server Key");m=core_hmac_sha1(str_sha1(binb2str(p)),u);this._sasl_data["server-signature"]=b64_hmac_sha1(w,u);for(k=0;k<5;k++){p[k]^=m[k]}r+=",p="+Base64.encode(binb2str(p));this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(c("response",{xmlns:e.NS.SASL}).t(Base64.encode(r)).tree());return false},_auth1_cb:function(g){var h=d({type:"set",id:"_auth_2"}).c("query",{xmlns:e.NS.AUTH}).c("username",{}).t(e.getNodeFromJid(this.jid)).up().c("password").t(this.pass);if(!e.getResourceFromJid(this.jid)){this.jid=e.getBareJidFromJid(this.jid)+"/strophe"}h.up().c("resource",{}).t(e.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(h.tree());return false},_sasl_success_cb:function(h){if(this._sasl_data["server-signature"]){var g;var l=Base64.decode(e.getText(h));var j=/([a-z]+)=([^,]+)(,|$)/;matches=l.match(j);if(matches[1]=="v"){g=matches[2]}if(g!=this._sasl_data["server-signature"]){this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}this._sasl_data=[];return this._sasl_failure_cb(null)}}e.info("SASL authentication succeeded.");this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}this._addSysHandler(this._sasl_auth1_cb.bind(this),null,"stream:features",null,null);this._sendRestart();return false},_sasl_auth1_cb:function(h){this.features=h;var g,l;for(g=0;g<h.childNodes.length;g++){l=h.childNodes[g];if(l.nodeName=="bind"){this.do_bind=true}if(l.nodeName=="session"){this.do_session=true}}if(!this.do_bind){this._changeConnectStatus(e.Status.AUTHFAIL,null);return false}else{this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2");var j=e.getResourceFromJid(this.jid);if(j){this.send(d({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:e.NS.BIND}).c("resource",{}).t(j).tree())}else{this.send(d({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:e.NS.BIND}).tree())}}return false},_sasl_bind_cb:function(g){if(g.getAttribute("type")=="error"){e.info("SASL binding failed.");var h=g.getElementsByTagName("conflict"),m;if(h.length>0){m="conflict"}this._changeConnectStatus(e.Status.AUTHFAIL,m);return false}var l=g.getElementsByTagName("bind");var j;if(l.length>0){j=l[0].getElementsByTagName("jid");if(j.length>0){this.jid=e.getText(j[0]);if(this.do_session){this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2");this.send(d({type:"set",id:"_session_auth_2"}).c("session",{xmlns:e.NS.SESSION}).tree())}else{this.authenticated=true;this._changeConnectStatus(e.Status.CONNECTED,null)}}}else{e.info("SASL binding failed.");this._changeConnectStatus(e.Status.AUTHFAIL,null);return false}},_sasl_session_cb:function(g){if(g.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(e.Status.CONNECTED,null)}else{if(g.getAttribute("type")=="error"){e.info("Session creation failed.");this._changeConnectStatus(e.Status.AUTHFAIL,null);return false}}return false},_sasl_failure_cb:function(g){if(this._sasl_success_handler){this.deleteHandler(this._sasl_success_handler);this._sasl_success_handler=null}if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}this._changeConnectStatus(e.Status.AUTHFAIL,null);return false},_auth2_cb:function(g){if(g.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(e.Status.CONNECTED,null)}else{if(g.getAttribute("type")=="error"){this._changeConnectStatus(e.Status.AUTHFAIL,null);this.disconnect()}}return false},_addSysTimedHandler:function(j,h){var g=new e.TimedHandler(j,h);g.user=false;this.addTimeds.push(g);return g},_addSysHandler:function(m,l,h,j,n){var g=new e.Handler(m,l,h,j,n);g.user=false;this.addHandlers.push(g);return g},_onDisconnectTimeout:function(){e.info("_onDisconnectTimeout was called");var g;while(this._requests.length>0){g=this._requests.pop();g.abort=true;g.xhr.abort();g.xhr.onreadystatechange=function(){}}this._doDisconnect();return false},_onIdle:function(){var j,m,o,l;while(this.addTimeds.length>0){this.timedHandlers.push(this.addTimeds.pop())}while(this.removeTimeds.length>0){m=this.removeTimeds.pop();j=this.timedHandlers.indexOf(m);if(j>=0){this.timedHandlers.splice(j,1)}}var h=new Date().getTime();l=[];for(j=0;j<this.timedHandlers.length;j++){m=this.timedHandlers[j];if(this.authenticated||!m.user){o=m.lastCalled+m.period;if(o-h<=0){if(m.run()){l.push(m)}}else{l.push(m)}}}this.timedHandlers=l;var g,n;if(this.authenticated&&this._requests.length===0&&this._data.length===0&&!this.disconnecting){e.info("no requests during idle cycle, sending blank request");this._data.push(null)}if(this._requests.length<2&&this._data.length>0&&!this.paused){g=this._buildBody();for(j=0;j<this._data.length;j++){if(this._data[j]!==null){if(this._data[j]==="restart"){g.attrs({to:this.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":e.NS.BOSH})}else{g.cnode(this._data[j]).up()}}}delete this._data;this._data=[];this._requests.push(new e.Request(g.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),g.tree().getAttribute("rid")));this._processRequest(this._requests.length-1)}if(this._requests.length>0){n=this._requests[0].age();if(this._requests[0].dead!==null){if(this._requests[0].timeDead()>Math.floor(e.SECONDARY_TIMEOUT*this.wait)){this._throttledRequestHandler()}}if(n>Math.floor(e.TIMEOUT*this.wait)){e.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(e.TIMEOUT*this.wait)+" seconds since last activity");this._throttledRequestHandler()}}clearTimeout(this._idleTimeout);if(this.connected){this._idleTimeout=setTimeout(this._onIdle.bind(this),100)}}};if(f){f(e,c,a,d,b)}})(function(){window.Strophe=arguments[0];window.$build=arguments[1];window.$msg=arguments[2];window.$iq=arguments[3];window.$pres=arguments[4]});Strophe.addNamespace("RSM","http://jabber.org/protocol/rsm");Strophe.RSM=function(a){this.attribs=["max","first","last","after","before","index","count"];if(typeof a.xml!="undefined"){this.fromXMLElement(a.xml)}else{for(var b=0;b<this.attribs.length;b++){var c=this.attribs[b];this[c]=a[c]}}};Strophe.RSM.prototype={toXML:function(){var a=$build("set",{xmlns:Strophe.NS.RSM});for(var b=0;b<this.attribs.length;b++){var c=this.attribs[b];if(typeof this[c]!="undefined"){a=a.c(c).t(this[c].toString()).up()}}return a.tree()},next:function(a){var b=new Strophe.RSM({max:a,after:this.last});return b},previous:function(a){var b=new Strophe.RSM({max:a,before:this.first});return b},fromXMLElement:function(b){for(var a=0;a<this.attribs.length;a++){var d=this.attribs[a];var c=b.getElementsByTagName(d)[0];if(typeof c!="undefined"&&c!==null){this[d]=Strophe.getText(c);if(d=="first"){this.index=c.getAttribute("index")}}}}};Strophe.addConnectionPlugin("chatstates",{init:function(a){this._connection=a;Strophe.addNamespace("CHATSTATES","http://jabber.org/protocol/chatstates")},statusChanged:function(a){if(a===Strophe.Status.CONNECTED||a===Strophe.Status.ATTACHED){this._connection.addHandler(this._notificationReceived.bind(this),Strophe.NS.CHATSTATES,"message")}},addActive:function(a){return a.c("active",{xmlns:Strophe.NS.CHATSTATES}).up()},_notificationReceived:function(c){var d=$(c).find("composing"),b=$(c).find("paused"),e=$(c).find("active"),a=$(c).attr("from");if(d.length>0){$(document).trigger("composing.chatstates",a)}if(b.length>0){$(document).trigger("paused.chatstates",a)}if(e.length>0){$(document).trigger("active.chatstates",a)}return true},sendActive:function(a,b){this._sendNotification(a,b,"active")},sendComposing:function(a,b){this._sendNotification(a,b,"composing")},sendPaused:function(a,b){this._sendNotification(a,b,"paused")},_sendNotification:function(a,b,c){if(!b){b="chat"}this._connection.send($msg({to:a,type:b}).c(c,{xmlns:Strophe.NS.CHATSTATES}))}});Strophe.addConnectionPlugin("archive",{_connection:null,init:function(a){this._connection=a;Strophe.addNamespace("DELAY","jabber:x:delay");Strophe.addNamespace("ARCHIVE","urn:xmpp:archive")},listCollections:function(b,c,d){var a=$iq({type:"get",id:this._connection.getUniqueId("list")}).c("list",{xmlns:Strophe.NS.ARCHIVE,"with":b});if(c){a=a.cnode(c.toXML())}this._connection.sendIQ(a,this._handleListConnectionResponse.bind(this,d))},retrieveMessages:function(a,c,b,d){new Strophe.ArchivedCollection(this._connection,a).retrieveMessages(c,b,d)},_handleListConnectionResponse:function(h,d){var c=[];var g=d.getElementsByTagName("chat");for(var b=0;b<g.length;b++){var a=g[b].getAttribute("with");var f=g[b].getAttribute("start");c.push(new Strophe.ArchivedCollection(this._connection,a,f))}var e=new Strophe.RSM({xml:d.getElementsByTagName("set")[0]});h(c,e)}});Strophe.ArchivedCollection=function(a,b){this.connection=a;this.jid=b};Strophe.ArchivedCollection.prototype={retrieveMessages:function(c,b,d){var a=$iq({type:"get",id:this.connection.getUniqueId("retrieve")}).c("retrieve",{xmlns:Strophe.NS.ARCHIVE,"with":this.jid,read:c});if(b){a=a.cnode(b.toXML())}this.connection.sendIQ(a,function(e){var h=[];var f=Strophe.getBareJidFromJid(this.connection.jid);var n;var g;var o=e.getElementsByTagName("chat")[0];var m=o.getAttribute("more")=="1";var l=(new Date()).setISO8601(o.getAttribute("start"));var j=o.firstChild;while(j){switch(j.tagName){case"to":g=this._incrementTimestampForMessage(l,j);h.push(new Strophe.ArchivedMessage(g,f,this.jid,$(j).find("body").text(),Boolean(parseInt(j.getAttribute("isRead"))),parseInt(j.getAttribute("id"))));break;case"from":g=this._incrementTimestampForMessage(l,j);h.push(new Strophe.ArchivedMessage(g,this.jid,f,$(j).find("body").text(),Boolean(parseInt(j.getAttribute("isRead"))),parseInt(j.getAttribute("id"))));break;case"set":n=new Strophe.RSM({xml:j});break;default:break}j=j.nextSibling}d(h,n,m)}.bind(this))},_incrementTimestampForMessage:function(d,c){var b=c.getAttribute("secs");var a=new Date("Y-m-d HH:mm:ss");a.setTime(d.getTime()+Number(b)*1000);return a}};Strophe.ArchivedMessage=function(b,f,e,a,c,d){this.timestamp=b;this.from=f;this.to=e;this.body=a;this.isRead=c;this.id=d};Strophe.ArchivedMessage.prototype={};Strophe.addConnectionPlugin("roster",{_connection:null,init:function(a){this._connection=a;Strophe.addNamespace("ROSTERX","http://jabber.org/protocol/rosterx");_.extend(this,Backbone.Events)},statusChanged:function(a,b){if(a===Strophe.Status.CONNECTED||a===Strophe.Status.ATTACHED){this._connection.addHandler(this._onReceivePresence.bind(this),null,"presence",null,null,null);this._connection.addHandler(this._onRosterSet.bind(this),Strophe.NS.ROSTER,"iq","set");this._connection.addHandler(this._onRosterSuggestion.bind(this),Strophe.NS.ROSTERX,"message",null)}},get:function(){var c=$.Deferred(),b,a=$iq({type:"get",id:this._connection.getUniqueId("roster")}).c("query",{xmlns:Strophe.NS.ROSTER});this._connection.sendIQ(a.tree(),function(d){b={};$.each($("item",d),function(e,f){b[f.getAttribute("jid")]={subscription:f.getAttribute("subscription"),name:f.getAttribute("name"),groups:$.map($("group",f),function(h,g){return $(h).text()})}});c.resolve(b)},c.reject);return c.promise()},subscribe:function(a){this._connection.send($pres({to:a,type:"subscribe"}))},unsubscribe:function(a){this._connection.send($pres({to:a,type:"unsubscribe"}))},authorize:function(a){this._connection.send($pres({to:a,type:"subscribed"}))},unauthorize:function(a){this._connection.send($pres({to:a,type:"unsubscribed"}))},update:function(e,b,a){var g=$.Deferred(),c,f=$iq({type:"set",id:this._connection.getUniqueId("roster")}).c("query",{xmlns:Strophe.NS.ROSTER}).c("item",{jid:e,name:b});for(c=0;c<a.length;c++){f.c("group").t(a[c]).up()}this._connection.sendIQ(f.tree(),g.resolve,g.reject);return g.promise()},_onReceivePresence:function(e){var d=e.getAttribute("from"),f=e.getAttribute("type"),b=(e.getElementsByTagName("show").length!==0)?Strophe.getText(e.getElementsByTagName("show")[0]):null,a=(e.getElementsByTagName("status").length!==0)?Strophe.getText(e.getElementsByTagName("status")[0]):null,c=(e.getElementsByTagName("priority").length!==0)?Strophe.getText(e.getElementsByTagName("priority")[0]):null;this.trigger("xmpp:presence",{jid:d,type:f,show:b,status:a,priority:c});switch(f){case null:this.trigger("xmpp:presence:available",{jid:d,show:b,status:a,priority:c});break;case"unavailable":this.trigger("xmpp:presence:unavailable",{jid:d});break;case"subscribe":this.trigger("xmpp:presence:subscriptionrequest",{jid:d});break;default:break}return true},_onRosterSet:function(c){var a=$("item",c);var b=_.map(a,function(e){var f=_.reduce(e.attributes,function(h,g){h[g.name]=g.value;return h},{});var d=_.map($("group",e),function(g){return g.textContent});if(d.length){f.groups=d}return f});this.trigger("xmpp:roster:set",b);return true},_onRosterSuggestion:function(d){var c=this,e=$(d).attr("from"),b,a;$.each($("item",d),function(f,g){b={from:e};_.each(g.attributes,function(h){b[h.name]=h.value});a=_.map($("groups",g),function(h){return h.textContent});if(a.length){b.groups=a}c.trigger("xmpp:roster:suggestion",b);switch(b.action){case"add":c.trigger("xmpp:roster:suggestion:add",b);break;case"delete":c.trigger("xmpp:roster:suggestion:delete",b);break;case"modify":c.trigger("xmpp:roster:suggestion:modify",b);break;default:break}});return true}});Strophe.addConnectionPlugin("message",{_connection:null,init:function(a){this._connection=a;Strophe.addNamespace("XHTML_IM","http://jabber.org/protocol/xhtml-im");Strophe.addNamespace("XHTML","http://www.w3.org/1999/xhtml");_.extend(this,Backbone.Events)},statusChanged:function(a,b){if(a===Strophe.Status.CONNECTED||a===Strophe.Status.ATTACHED){this._connection.addHandler(this._onReceiveChatMessage.bind(this),null,"message","chat")}},_onReceiveChatMessage:function(b){var a,c;if($(b).find("delay")[0]){return true}a=$(b).children("body").text();if(a===""){return true}c=$('html[xmlns="'+Strophe.NS.XHTML_IM+'"] > body',b);if(c.length>0){c=$("<div>").append(c.contents()).html()}else{c=null}this.trigger("xmpp:message",{jid:b.getAttribute("from"),type:b.getAttribute("type"),body:a,html_body:c});return true},send:function(d,a,c){var b=$msg({to:d,type:"chat"});if(a){b.c("body",{},a)}if(c){b.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).h(c)}this._connection.send(b.tree())}});var ServerDate=function(){if(arguments.length===0){return new Date(new Date().valueOf()+ServerDate.skew)}else{if(arguments.length===1){return new Date(arguments[0])}else{return new Date(Date.UTC.apply(null,arguments)+((new Date()).getTimezoneOffset()*60000))}}};ServerDate.parse=Date.parse;ServerDate.UTC=Date.UTC;ServerDate.now=function(){return(new ServerDate()).valueOf()};ServerDate.skew=0;ServerDate.prototype.toUTCString=function(){var b=function(c){return(c=c+"",c.length==2)?c:"0"+c};return function(){var c=[this.getUTCFullYear(),b(this.getUTCMonth()+1),b(this.getUTCDate())].join("-"),a=[b(this.getUTCHours()),b(this.getUTCMinutes()),b(this.getUTCSeconds())].join(":")+"."+this.getMilliseconds();return[c,a].join("T")+"Z"}};Strophe.addConnectionPlugin("serverdate",{init:function(a){Strophe.Request.prototype._newXHR=function(){var c=null;if(window.XMLHttpRequest){c=new XMLHttpRequest();if(c.overrideMimeType){c.overrideMimeType("text/xml")}}else{if(window.ActiveXObject){c=new ActiveXObject("Microsoft.XMLHTTP")}}var b=this.func.bind(null,this);c.onreadystatechange=function(){if(this.readyState==2){var e=this.getResponseHeader("Date");var d=new Date(e);if(e&&d!="Invalid Date"){ServerDate.skew=d-new Date()}}b()};return c}}});var $commonData=$("#common-data");var chatServer=$commonData.data("chat-server");var chatServerDomain="@"+$commonData.data("chat-domain");var pubsubService="pubsub."+$commonData.data("chat-domain");var myTemplate={tplContactItem:'<div class="avatar"><img src="<%= avatarUrl%>" alt="<%= name %>" title="<%= name %>" width="50" height="50"></div><div class="nickname"><%= name %></div><div class="unread-count"><%=unReadCount%></div><% if( typeof body != "undefined" ) { %><div class="last-message"><%- body %></div><% } %>',tplChatBox:'<div class="chat-title"><a href="<%=profileUrl%>" target="_blank" >           <img class="avatar" src="<%= avatarUrl%>" alt="<%= name %>" title="<%= name %>">           <span class="name"><%=name%></span></a>       </div>       <div class="chat-message-container">            <div class="message-list"><a class="more-history" href="#">查看更多消息</a></div>            <div class="chat-status">对方正在输入...</div>       </div>       <div class="chat-editor">           <textarea type="text" class="chat-input" rows="2" ></textarea>           <button class="btn btn-primary btn-send">发送</button>       </div>',tplMessageItem:'<% if(typeof formattedTime != "undefined"){  %><div class="message-time-wrapper"><div class="message-time"><span class="time-span left"/><%=formattedTime%><span class="time-span right"/></div></div><% } %><a href="<%=profileUrl%>" target="_blank" ><img class="avatar" src="<%= avatarUrl%>" alt="<%= name %>" title="<%= name %>"></a><div class="message-content"><div class="message-text"><%- body%></div><div class="message-arrow"></div></div>',tplNotification:"<li class='noty <%=type%>' ><a href='<%=url%>' target='_blank'>    <img src='<%=s_avatar %>' class='avatar' alt='<%= name %>'/>   <div class='action'>       <div class='name'><%= name%> </div>       <div class='event'><%=event%></div>       <%if (typeof target_text !='undefined'){ %> <div class='target-text'><%=target_text%></div><%}%>   </div><div class='extra_info'><div class='noty-time'><%=date%></div><button class='close ignore-noty'>×</button><%if (typeof target_pic !='undefined'){ %><img src='<%=target_pic%>' alt='' class='target-pic'/><%}%></div></a></li>"};var $chatData=$("#chat-data");var Contact=Backbone.Model.extend({defaults:{show:"offline",name:"",isTyping:false,unReadCount:0,current:false,avatarUrl:$chatData.data("default-avatar"),profileUrl:"",hasMoreUnReadMessages:true,hasMoreReadMessages:false},initialize:function(){this.messages=new MessageCollection()},url:$chatData.data("get-user-info-url"),addMessage:function(b){if(b.isIn()){var a=b.sender;if(!b.get("isRead")){if(chatApp.isWindowFocused&&a.get("current")){a.sendReceivedRecipts()}else{a.increaseUnReadCount(1)}}}this.messages.add(b)},retrieveUnReadMessages:function(){var b=this.messages.length>0?this.messages.first().get("timestamp").getTime():"";var a=this;this.retrieveMessages(b,function(){if(a.get("hasMoreUnReadMessages")){a.retrieveUnReadMessages()}})},retrieveMessages:function(d,e){var b=this,a=10,c=new Strophe.RSM({max:a,before:d||""});chatApp.connection.archive.retrieveMessages(this.get("jid"),2,c,function(h,g,f){var j=f;_.each(h,function(l){var m=new Message({from:Strophe.getNodeFromJid(l.from),to:Strophe.getNodeFromJid(l.to),body:l.body,timestamp:l.timestamp,isRead:l.isRead});if(j&&m.sender==chatApp.myProfile||l.isRead){j=false}if(m.isIn()&&m.sender){m.sender.addMessage(m)}else{if(!m.isIn()&&m.receiver){m.receiver.addMessage(m)}}});b.set("hasMoreUnReadMessages",j);b.set("hasMoreReadMessages",f);e&&e()})},increaseUnReadCount:function(b){var a=this.get("unReadCount");this.set("unReadCount",a+b);chatApp.totalUnReadCount+=b;var c=$("#total-unread-count");c.text(chatApp.totalUnReadCount).show();if(!chatApp.unReadMsgInterval){chatApp.unReadMsgInterval=setInterval(function(){if(chatApp.totalUnReadCount>0){c.is(":visible")?c.hide():c.show()}else{c.hide()}},1000)}},clearUnReadCount:function(){var a=this.get("unReadCount");if(a){this.sendReceivedRecipts();this.set("unReadCount",0);chatApp.totalUnReadCount-=a;$("#total-unread-count").text(chatApp.totalUnReadCount);if(chatApp.totalUnReadCount==0){$("#total-unread-count").hide()}}},sendReceivedRecipts:function(){var a=$msg({to:this.get("jid")}).c("received",{xmlns:"urn:xmpp:receipts"});chatApp.connection&&chatApp.connection.send(a)}});var ContactCollection=Backbone.Collection.extend({model:Contact,url:$chatData.data("get-user-info-url"),getCurrentUser:function(){return this.findWhere({current:true})}});var ContactItemView=Backbone.View.extend({tagName:"div",className:"contact-item",id:function(){return"contact-"+this.model.id},template:_.template(myTemplate.tplContactItem),initialize:function(){this.listenTo(this.model,"change",this.render);this.listenTo(this.model.messages,"add",this.render);this.listenTo(this.model,"destory",this.close)},close:function(){this.$el.unbind();this.$el.remove()},render:function(){var c=this.model.messages,b,a;if(c.length){b=c.last();a={body:b.get("body").slice(0,20),timestamp:b.get("timestamp").getTime()}}else{a={}}this.$el.html(this.template(_.extend({},this.model.attributes,a))).removeClass("online offline").addClass(this.model.get("show"));if(this.model.get("current")){this.$el.addClass("current")}else{this.$el.removeClass("current")}if(this.model.get("unReadCount")>0){this.$el.find(".unread-count").show()}else{this.$el.find(".unread-count").hide()}return this},events:{click:"openChat"},openChat:function(b){if(!chatApp.hasAvatar()){$("#no-avatar-tip").show();return false}else{$("#no-avatar-tip").hide()}var d=chatApp.contactList.getCurrentUser();d&&d.set("current",false);var c=$(b.currentTarget).attr("id").replace("contact-","");var a=chatApp.contactList.get(c);a.set("current",true);a.clearUnReadCount();return false}});var ContactListView=Backbone.View.extend({el:"#roster",initialize:function(){this.itemViewList=[];this.model.each(function(a){var b=new ContactItemView({model:a});this.itemViewList.push(b);this.listenTo(a.messages,"sort add",function(){this.sortContacts();this.render()})},this);this.listenTo(this.model,"change",this.render);this.listenTo(this.model,"change:show",function(){this.sortContacts();this.render()});this.listenTo(this.model,"add",function(a){if($("#no-roster-tip")[0]){$("#no-roster-tip").remove();$("#chat-left-column, #chat-right-column").show()}var b=new ContactItemView({model:a});this.itemViewList.push(b);this.listenTo(a.messages,"sort add",function(){this.sortContacts();this.render()});this.sortContacts();this.render()});this.sortContacts();this.render()},render:function(){_.each(this.itemViewList,function(a){this.$el.prepend(a.el)},this);this.$el.children().removeClass("first").first().addClass("first");if(this.$el.children().size()==9){this.$el.children().removeClass("last").last().addClass("last")}return this},sortContacts:function(){this.itemViewList=_.sortBy(this.itemViewList,function(a){var b=a.model.messages;return b.length?b.last().get("timestamp").getTime():(a.model.get("show")=="online"?1:0)})}});var Message=Backbone.Model.extend({defaults:{isRead:false},initialize:function(){var b=this.get("from"),a=this.get("to");if(chatApp.contactList.get(b)){this.sender=chatApp.contactList.get(b)}else{if(b==chatApp.myProfile.id){this.sender=chatApp.myProfile}else{this.sender=chatApp.createContact(b+chatServerDomain);this.sender.retrieveUnReadMessages()}}if(chatApp.contactList.get(a)){this.receiver=chatApp.contactList.get(a)}else{if(a==chatApp.myProfile.id){this.receiver=chatApp.myProfile}else{this.receiver=chatApp.createContact(a+chatServerDomain);this.receiver.retrieveUnReadMessages()}}},shouldShowTime:function(){var c=this.collection,b=c.indexOf(this),a,d=false;if(b>0){a=c.at(b-1);(this.get("timestamp")-a.get("timestamp"))/1000/60>=15&&(d=true)}else{if(b==0){d=true}}return d},isIn:function(){return this.get("from")!=chatApp.myProfile.id}});var MessageCollection=Backbone.Collection.extend({model:Message,comparator:function(a){return a.get("timestamp").getTime()}});var MessageItemView=Backbone.View.extend({tagName:"div",className:"message-item",template:_.template(myTemplate.tplMessageItem),initialize:function(){this.listenTo(this.model,"change:shouldScrollIntoView",function(){if(this.model.get("shouldScrollIntoView")){this.el.scrollIntoView(false);var a=this.$el.parents(".message-list");a.scrollTop(a.scrollTop()+115)}})},render:function(){var a={};if(this.model.shouldShowTime()){a.formattedTime=this.formatTime(this.model.get("timestamp"))}this.$el.html(this.template(_.extend({},this.model.attributes,this.model.sender.attributes,a))).addClass(this.model.isIn()?"others":"me");return this},formatTime:function(a){var b=a.getHourMinute();return chatApp.formatDate(a)+" "+b}});var ChatBoxView=Backbone.View.extend({tagName:"div",className:"chat-box",template:_.template(myTemplate.tplChatBox),initialize:function(){this.listenTo(this.model,"change:current change:isTyping change:name change:hasMoreReadMessages change:hasMoreUnReadMessages",this.render);this.listenTo(this.model.messages,"add",this.addMessageView);this.$el.html(this.template(this.model.attributes))},addMessageView:function(d,b){var a=new MessageItemView({model:d}).render().el;var c=b.indexOf(d);if(c==0){this.$(".message-list .more-history").after(a)}else{this.$(".message-list .message-item:eq("+(c-1)+")").after(a);if(c+1<b.length&&!b.at(c+1).shouldShowTime()){this.$(".message-list .message-item:eq("+(c+1)+")").find(".message-time-wrapper").hide()}}if(c==b.length-1){this._scrollChatToBottom()}},render:function(){if(this.model.hasChanged("name")){var b=this.$(".message-list").detach();this.$el.html(this.template(this.model.attributes));b[0]&&this.$(".message-list").replaceWith(b)}if(this.model.hasChanged("hasMoreUnReadMessages")||this.model.hasChanged("hasMoreReadMessages")){if(!this.model.get("hasMoreUnReadMessages")&&this.model.get("hasMoreReadMessages")){this.$(".more-history").show()}else{this.$(".more-history").hide()}}var a=this.model.get("current");if(this.model.hasChanged("current")){if(a){this.$el.show();this.$el.find(".chat-input").focus()}else{this.$el.hide()}this._scrollChatToBottom()}a&&this.model.get("isTyping")?this.$el.find(".chat-status").css("visibility","visible"):this.$el.find(".chat-status").css("visibility","hidden");return this},events:{"keypress .chat-input":"keyPressed","focusout .chat-input":"sendPausedStatus","click .btn-send":"sendMessage","click .more-history":"getMoreHistory"},keyPressed:function(a){if(a.which===13){a.preventDefault();this.sendMessage()}else{if(!chatApp.checkConnection()){return}this.sendTypingStatus()}},sendMessage:function(){var c=this.$el.find(".chat-input");var b=c.val();if(!b){return false}c.val("");if(!chatApp.checkConnection()){return false}var a=chatApp.contactList.getCurrentUser();chatApp.connection.message.send(a.get("jid"),b);if(chatApp.myProfile.get("isTyping")){chatApp.myProfile.set("isTyping",false)}if(chatApp.statesTimeOut){clearTimeout(chatApp.statesTimeOut);chatApp.statesTimeOut=null}a.addMessage(new Message({from:chatApp.myProfile.id,to:a.id,body:b,timestamp:new ServerDate()}));this._scrollChatToBottom();$("#chat-left-column").scrollTop(0);return false},sendTypingStatus:function(){if(!chatApp.myProfile.get("isTyping")){chatApp.connection.chatstates.sendComposing(chatApp.contactList.getCurrentUser().get("jid"),"chat");chatApp.myProfile.set("isTyping",true)}if(chatApp.statesTimeOut){clearTimeout(chatApp.statesTimeOut);chatApp.statesTimeOut=null}else{chatApp.statesTimeOut=setTimeout(this.sendPausedStatus,10000)}},sendPausedStatus:function(){if(chatApp.myProfile.get("isTyping")){chatApp.myProfile.set("isTyping",false);if(!chatApp.checkConnection()){return}chatApp.connection.chatstates.sendPaused(chatApp.contactList.getCurrentUser().get("jid"),"chat")}if(chatApp.statesTimeOut){clearTimeout(chatApp.statesTimeOut);chatApp.statesTimeOut=null}},getMoreHistory:function(){var a=chatApp.contactList.getCurrentUser();var b=a.messages.first();a.retrieveMessages(a.messages.first().get("timestamp").getTime(),function(){a.messages.at(a.messages.indexOf(b)-1).set("shouldScrollIntoView",true)});return false},_scrollChatToBottom:function(){var a=this.$(".message-list")[0];a.scrollTop=a.scrollHeight}});var ChatBoxListView=Backbone.View.extend({el:"#chat-right-column",initialize:function(){this.listenTo(this.model,"add",function(a){this.$el.append(new ChatBoxView({model:a}).render().el)},this);this.render()},render:function(){_.each(this.model.models,function(a){this.$el.append(new ChatBoxView({model:a}).render().el)},this);return this}});var chatApp={UNREAD_MSG:0,READ_MSG:1,ALL_MSG:2,isVisible:function(){return $("#chat-dialog").is(":visible")},connection:null,totalUnReadCount:0,myProfile:new Contact({id:$commonData.data("uid"),avatarUrl:$chatData.data("my-avatar"),profileUrl:$chatData.data("profile-url"),name:$chatData.data("my-name")}),hasAvatar:function(){return this.myProfile.get("avatarUrl")!=$chatData.data("defaultAvatar")},isWindowFocused:false,orignalWindowTitle:$("title").text(),unReadMsgInterval:null,initialized:false,initialize:function(){this.initialized=true;$("#chat-dialog").on("shown",chatApp.setRead)},setRead:function(){try{if(chatApp.isVisible()&&chatApp.contactList.getCurrentUser()&&chatApp.contactList.getCurrentUser().get("unReadCount")>0){chatApp.contactListView.$el.find(".current").click()}}catch(a){}},checkConnection:function(){if(!this.connection){alert("连接已断开，点击确认后自动刷新页面");setTimeout(function(){location.reload()},1000);return false}else{return true}},listContacts:function(b){var a=_.map(b,function(c,d){return new Contact({id:Strophe.getNodeFromJid(d),jid:d})});this.contactList=new ContactCollection(a);a.length&&this.contactList.fetch({type:"post",data:{ids:_.pluck(a,"id").join(",")}});this.contactListView=new ContactListView({model:this.contactList});this.chatBoxListView=new ChatBoxListView({model:this.contactList});if(a.length==0){return}$(window).resize();this.contactList.each(function(c){c.retrieveUnReadMessages()})},createContact:function(b){var a=new Contact({id:Strophe.getNodeFromJid(b),jid:b});a.fetch({type:"post",data:{id:a.id}});chatApp.contactList.add(a);$(window).resize();return a},formatDate:function(b){var a=new ServerDate();var e,d,c,f;e=new Date(b.getFullYear(),b.getMonth(),b.getDate());d=new Date(a.getFullYear(),a.getMonth(),a.getDate());c=Math.abs(e-d)/1000/60/60/24;if(c==0){f=""}else{if(c==1){f="昨天"}else{if(c==2){f="前天"}else{f=b.getTwoDigitMonth()+"-"+b.getTwoDigitDate()}}}return f},log:function(a){if(typeof console!="undefined"){console.log(a)}},debug:function(a){if(typeof console!="undefined"){console.log(a)}}};var notyApp={$notyList:$("#notification-list"),$noNotyTip:$("#no-noty-tip"),totalNotyUnReadCount:0,leftUnReadCount:0,eldestTimestamp:new ServerDate().getTime(),hasMoreUnReadMessages:true,tplNoty:_.template(myTemplate.tplNotification),initialize:function(){chatApp.connection.addHandler(notyApp.onNotification,null,"message","");$("#more-noty").click(function(){var a=notyApp.hasMoreUnReadMessages?chatApp.UNREAD_MSG:chatApp.ALL_MSG;notyApp.retrieveNoty(a,notyApp.eldestTimestamp);return false});$("#ignore-all-noty").click(function(){notyApp.sendNotyReadReceipt();notyApp.decreaseNotyUnReadCount(notyApp.totalNotyUnReadCount);notyApp.$notyList.children().fadeOut(300,function(){notyApp.$notyList.html("");notyApp.showNoNotyTip()});return false});notyApp.$notyList.delegate(".noty","click",function(){if(!$(this).hasClass("read")){notyApp.decreaseNotyUnReadCount();notyApp.sendNotyReadReceipt($(this).data("noty-id"))}$(this).fadeOut(function(){$(this).remove();notyApp.showNoNotyTip()})}).delegate(".noty","mouseenter",function(){$(this).addClass("hover")}).delegate(".noty","mouseleave",function(){$(this).removeClass("hover")}).delegate(".ignore-noty","click",function(){var a=$(this).parents(".noty");if(!a.hasClass("read")){notyApp.decreaseNotyUnReadCount();notyApp.sendNotyReadReceipt(a.data("noty-id"))}a.fadeOut(function(){$(this).remove();notyApp.showNoNotyTip()});return false})},createNoty:function(g,b,f,e,a){var d=g.attr("node"),c;!e&&a&&notyApp.increaseNotyUnReadCount(g.size());g.each(function(h,l){try{c=$.parseJSON($(l).find("entry").text());if(!c.s_avatar){c.s_avatar=c.avatar}var n=chatApp.formatDate(f);c.date=n?n:f.getHourMinute();if(d.indexOf("meal")>0){c.url="/meal/"+c.meal+"/";c.type="meal";c.target_text=c.topic;c.target_pic=c.meal_photo}else{if(d.indexOf("/photos")>0){c.url="/photo/"+c.photo_id+"/";c.type="photo";c.target_pic=c.photo}else{if(d.indexOf("/followers")>0){c.url="/user/"+c.user+"/";c.type="follower"}else{if(d.indexOf("visitors")>0){c.url="/user/"+c.user+"/";c.type="visitor"}}}}var j=$(notyApp.tplNoty(c));j.data("noty-id",b);e&&j.addClass("read");if(a){notyApp.$notyList.prepend(j)}else{notyApp.$notyList.append(j)}}catch(m){}})},sendNotyReadReceipt:function(b){b=b||0;var a=$msg({to:pubsubService}).c("received",{xmlns:"urn:xmpp:receipts",id:b});chatApp.connection&&chatApp.connection.send(a)},retrieveNoty:function(d,c){c=c||"";var a=10,b=new Strophe.RSM({max:a,before:c});chatApp.connection.archive.retrieveMessages(pubsubService,d,b,function(g,f,e){if(g.length>0){notyApp.eldestTimestamp=g[0].timestamp.getTime();notyApp.$noNotyTip.hide()}if(notyApp.hasMoreUnReadMessages&&d==chatApp.UNREAD_MSG&&e){notyApp.hasMoreUnReadMessages=true}else{notyApp.hasMoreUnReadMessages=false}if(d==chatApp.UNREAD_MSG&&!c){notyApp.increaseNotyUnReadCount(parseInt(f.count));notyApp.leftUnReadCount=notyApp.totalNotyUnReadCount}if(d==chatApp.UNREAD_MSG){notyApp.leftUnReadCount-=g.length;notyApp.updateLeftUnReadCount()}g.reverse();_.each(g,function(h){try{notyApp.createNoty($($.parseXML(h.body)).find("items"),h.id,h.timestamp,h.isRead,false)}catch(j){}})})},updateLeftUnReadCount:function(){if(notyApp.leftUnReadCount){$("#more-noty").text("查看更多 ("+notyApp.leftUnReadCount+")")}else{$("#more-noty").text("查看更多")}},onNotification:function(b){var a=$(b);if(!a.find("delay")[0]&&a.find("event")[0]){var c=a.find("items");notyApp.createNoty(c,a.attr("id"),new ServerDate(),false,true)}return true},increaseNotyUnReadCount:function(a){a&&notyApp.$noNotyTip.hide();var b=$("#total-noty-unread-count");this.totalNotyUnReadCount+=a;b.text(this.totalNotyUnReadCount);if(!this.notyIndicatorInterval){this.notyIndicatorInterval=setInterval(function(){if(notyApp.totalNotyUnReadCount!=parseInt(b.text())){b.text(notyApp.totalNotyUnReadCount)}if(notyApp.totalNotyUnReadCount>0){b.is(":visible")?b.hide():b.show()}else{b.hide()}},1000)}},decreaseNotyUnReadCount:function(a){var a=a||1;if(this.totalNotyUnReadCount-a>0){this.totalNotyUnReadCount-=a}else{this.totalNotyUnReadCount=0}notyApp.showNoNotyTip()},showNoNotyTip:function(){!notyApp.$notyList.children().size()&&notyApp.$noNotyTip.show()}};$(function(){Strophe.log=function(b,a){};$(document).bind("connect",function(b,c){var a=new Strophe.Connection(chatServer);a.xmlInput=function(d){if($(d).find("chat")[0]||$(d).find("message")[0]){chatApp.debug(d)}};a.xmlOutput=function(d){if($(d).find("retrieve")[0]){chatApp.debug(d)}};a.rawInput=function(d){};a.rawOutput=function(d){};a.connect(c.jid,c.password,function(d){if(d===Strophe.Status.CONNECTED){$(document).trigger("connected")}else{if(d===Strophe.Status.DISCONNECTED){$(document).trigger("disconnected");chatApp.connection=null}}});chatApp.connection=a});$(document).bind("connected",function(){if(chatApp.initialized){return}notyApp.initialize();chatApp.initialize();notyApp.retrieveNoty(chatApp.UNREAD_MSG);chatApp.connection.roster.get().done(function(a){chatApp.listContacts(a);chatApp.connection.send($pres());$("#chat-dialog").on("show",function(){if(chatApp.contactList.length==0){location.href=$("#nav-user").find("a").attr("href")+"?showChatTip=1";return false}else{return true}});if(chatApp.isVisible()){$("#chat-dialog").trigger("show")}});$(".btn-follow").live("click",function(){chatApp.connection.roster.subscribe($(this).data("uid")+chatServerDomain)});$(".btn-chat").click(function(){var b=$(this).data("uid");var a=b+chatServerDomain;if(!chatApp.contactList.get(b)){chatApp.createContact(a).retrieveMessages();chatApp.connection.roster.subscribe(a)}$("#chat-dialog").modal({show:true});chatApp.contactListView.$el.find("#contact-"+b).click();return false});chatApp.connection.roster.on("xmpp:presence:available",function(b){var a=chatApp.contactList.get(Strophe.getNodeFromJid(b.jid));a&&a.set("show","online")}).on("xmpp:presence:unavailable",function(b){var a=chatApp.contactList.get(Strophe.getNodeFromJid(b.jid));a&&a.set("show","offline")}).on("xmpp:presence:subscriptionrequest",function(a){chatApp.connection.roster.authorize(a.jid);chatApp.connection.roster.subscribe(a.jid)}).on("xmpp:roster:set",function(a){_.each(a,function(b){if(b.subscription!="remove"&&!chatApp.contactList.get(Strophe.getNodeFromJid(b.jid))){chatApp.createContact(b.jid).retrieveMessages()}})});chatApp.connection.message.on("xmpp:message",function(b){var d=Strophe.getNodeFromJid(b.jid);if(d!=chatApp.myProfile.id){var a=!chatApp.contactList.get(d);var c=new Message({from:d,to:chatApp.myProfile.id,body:b.body,timestamp:new ServerDate()});if(c.sender.messages.where({body:b.body}).length){chatApp.log("duplicate msg")}!a&&c.sender.addMessage(c);c.sender.set("isTyping",false)}});$(document).bind("composing.chatstates",function(c,b){var a=chatApp.contactList.get(Strophe.getNodeFromJid(b));a&&a.set("isTyping",true)}).bind("paused.chatstates",function(c,b){var a=chatApp.contactList.get(Strophe.getNodeFromJid(b));a&&a.set("isTyping",false)})});$(window).bind("beforeunload",function(){try{if(chatApp.connection){chatApp.connection.disconnect();chatApp.connection=null}}catch(a){}});$(window).focus(function(){chatApp.isWindowFocused=true;chatApp.setRead()}).blur(function(){chatApp.isWindowFocused=false});$(window).resize(function(){if($("#chat-container")){var a=$(window).height();if(a>700){$("#chat-dialog").height(640);$("#chat-container").height(590);$(".message-list").height(470)}else{if(a<260){$("#chat-dialog").height(190);$("#chat-container").height(140);$(".message-list").height(20)}else{$("#chat-dialog").height(a-60);$("#chat-container").height(a-110);$(".message-list").height(a-230)}}}});$(document).trigger("connect",{jid:$commonData.data("uid")+chatServerDomain,password:$commonData.data("pwd")})});