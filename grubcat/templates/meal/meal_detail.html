{% extends "base.html" %}
{% load static_asset %}
{% load static from staticfiles %}{% load assets %}
{% block title %}{{ meal.topic }}{% endblock %}
{% block page_css %}
    {{ block.super }}
    {% assets "module_css" %}
        <link href="{% static_asset ASSET_URL %}" media="screen" rel="stylesheet" type="text/css">
    {% endassets %}
{% endblock %}
{#{% block active-nav-id %}nav-meal{% endblock %}#}
{% block content %}
    <div class="row" id="meal-detail-page">
        <div id="meal-detail" class="span9">
            {% if just_created %}
                <div class="alert" id="create_meal_alert">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    只差一步，就创建完成了！支付成功后，其他的朋友便可以参加了哦！
                </div>
            {% endif %}
            <div class="meal-simple-info box-seperator clearfix">

                <h1>{{ meal.topic }}</h1>
                <span id="restaurant-location"><a href="http://maps.google.com.hk?q={{ meal.menu.restaurant.name }}"
                                                  target="_blank"
                                                  class="restaurant-name">{{ meal.menu.restaurant.name }}</a> {{ meal.menu.restaurant.address }}</span>
           <span class="date fr">{{ meal.start_date|date:"n" }}月{{ meal.start_date|date:"j" }}日 {{ meal.start_date|date:"D" }}
               {{ meal.start_time|date:"G:i " }}</span>
            </div>
            <p id="desc">{{ meal.introduction }}</p>

            <div id="meal-container" class="clearfix box-seperator">
                <div class="meal-img-wrapper">
                    <img alt="{{ meal.topic }}" class="img-polaroid"
                         src="{{ meal.big_cover_url }}"
                         width="420" height="280">
                </div>
                <div id="meal-grub">
                    {% if order %}
                        <a href="{% url order_detail meal.id order.id %}"
                           class="btn btn-primary btn-book btn-booked fr">
                            已预订 查看订单
                        </a>
                    {% elif meal.is_passed %}
                        <a href="#"
                           class="btn btn-passed btn-book fr">
                            已结束
                        </a>
                    {% elif meal.left_persons > 0 %}
                        {% if user.is_authenticated %}
                            {% if just_created %}
                                <a href="#"
                                   class="btn btn-primary btn-book btn-book-now fr">
                                    去支付
                                </a>
                            {% else %}
                                <a href="#"
                                   class="btn btn-primary btn-book btn-book-now fr">
                                    马上预定
                                </a>
                            {% endif %}
                        {% else %}
                            <a href="{% url weibo_login %}?next={% url meal_detail meal.id %}"
                               class="btn btn-primary btn-book fr">
                                马上预定
                            </a>
                        {% endif %}
                        <form id="order_info_form" method="post" target="{% comment %}_blank{% endcomment %}"
                              class="form-horizontal"> {% csrf_token %}
                            <fieldset>
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                <div class="control-group num_persons">
                                    <label class="control-label" for="id_num_persons">为几人付款:</label>

                                    <div class="controls">
                                        {{ form.num_persons }}
                                    </div>
                                </div>

                                <div class="control-group">
                                    <label class="control-label">单价:</label>

                                    <div class="controls">
                                        <label>¥ <span id="meal_price">{{ meal.list_price }}</span></label>
                                    </div>
                                </div>

                                <div class="control-group">
                                    <label class="control-label">总价:</label>

                                    <div class="controls">
                                        <label>¥ <span id="total_price" class="bl">{{ meal.list_price }}</span> </label>
                                    </div>
                                </div>
                            </fieldset>
                        </form>
                    {% elif meal.left_persons <= 0 %}
                        <a href=""
                           class="btn btn-book btn-sold-out btn-danger fr">
                            卖光了
                            {#                        <span class="mt5">{{ meal.list_price }}RMB/人</span>#}
                        </a>
                    {% endif %}


                </div>

            </div>
            <div id="users" class="">
                {% if meal.actual_persons %}
                    {% if meal.left_persons <= 0 %}
                        <h3 id="left_persons_tip" data-left-persons="0">没有空位了！</h3>
                    {% else %}
                        <h3 id="left_persons_tip" data-left-persons="{{ meal.left_persons }}">还剩{{ meal.left_persons }}个空位，快来预定吧！</h3>
                    {% endif %}
                {% else %}
                    <h3 id="left_persons_tip" data-left-persons="{{ meal.left_persons }}">现在还没有人参加饭局，赶快预定吧！</h3>
                {% endif %}
                {% for user in meal.participants.all %}
                    <a href="{% url user_detail user.id %}" class="user-img-wrapper"
                       title="{{ user.name }}">
                        <img alt="{{ user.name }}" width="80"
                             height="80" class=""
                             src="{{ user.normal_avatar }}">
                    </a>
                {% endfor %}

                {% for empty_user in avaliable_seats %}
                    <div class="empty-user-wrapper">
                        <img class="seat-placeholder " width="80"
                             height="80"
                             src="{% static 'img/default/seat-placeholder.png' %}">
                    </div>
                {% endfor %}

            </div>
        </div>
        <div class="sidebar span3  visible-desktop">

            {% include "support/faq_sidebar.html" %}

            <div id="menu" class="menu sidebar-box">
                <div class="sidebar-box-title">
                    菜单 {% comment %}{{ meal.menu.name|default:"8人套餐 40元/人" }}{% endcomment %}</div>
                <div class="sidebar-box-content">
                    {% include 'meal/menu_frag.html' with menu=meal.menu %}
                </div>
            </div>
        </div>
{% comment %}        <div id="pay_result_dialog" class="modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4>支付</h4>
            </div>
            <div class="modal-body">
                <a id="btn-pay-fail" class="btn" href="">支付遇到问题</a>
                <a id="btn-pay-sucess" class="btn btn-primary btn-large" href="">支付成功</a>
            </div>
        </div>{% endcomment %}
    </div>
    <div id="data" style="display: none" data-check-order-status-link="{% url check_order_status meal.id%}" {% if request.GET.num %}data-num-persons="{{ request.GET.num }}{% endif %}"></div>
{% endblock %}

{% block page_js %}
    {{ block.super }}
    {% assets "module_js" %}
        <script type="text/javascript" src="{% static_asset ASSET_URL %}"></script>
    {% endassets %}
{% endblock %}